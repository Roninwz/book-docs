<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ReactæŠ€æœ¯æ­ç§˜</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script src="/book-docs/react-analysis/assets/js/tj.js"></script>
    <meta name="description" content="Reactæºç è§£æ">
    
    <link rel="preload" href="/book-docs/react-analysis/assets/css/0.styles.6b071643.css" as="style"><link rel="preload" href="/book-docs/react-analysis/assets/js/app.c42aa1da.js" as="script"><link rel="preload" href="/book-docs/react-analysis/assets/js/2.ab464fc7.js" as="script"><link rel="preload" href="/book-docs/react-analysis/assets/js/22.b2320cf7.js" as="script"><link rel="preload" href="/book-docs/react-analysis/assets/js/3.bd8ee395.js" as="script"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/10.fbded8cf.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/11.289d6c66.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/12.870f191a.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/13.59b0cb7d.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/14.cd758e90.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/15.a09ba33a.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/16.e6edbb6b.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/17.cf66438c.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/18.fb23468a.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/19.25703c84.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/20.eda559ea.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/21.cab6e748.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/23.73c35c9d.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/24.efc917a9.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/25.e370ed97.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/26.ab0676c9.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/27.e498bc4f.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/28.4216510f.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/29.ef001e90.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/30.df8ec67b.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/31.3e3297f8.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/32.cf12efa8.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/33.266eee65.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/34.29e02a4a.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/35.75411d8e.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/36.0f9c40b9.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/37.5980d866.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/38.fb4713ce.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/39.b35cc2fa.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/4.c6061572.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/40.951223e3.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/41.7f455382.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/42.16854cf0.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/43.ca836c33.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/44.9689a8a2.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/45.ab80d190.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/46.ea324e2d.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/47.f5e188fc.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/5.8e19291d.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/6.311ac735.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/7.74392417.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/8.42267bd5.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/9.84e8a951.js">
    <link rel="stylesheet" href="/book-docs/react-analysis/assets/css/0.styles.6b071643.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/book-docs/react-analysis/" class="home-link router-link-active"><!----> <span class="site-name">ReactæŠ€æœ¯æ­ç§˜</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/book-docs/react-analysis/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·æˆé•¿
</a></div><div class="nav-item"><a href="https://ke.segmentfault.com/course/1650000023864436" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ”¥ è§†é¢‘è¯¾ç¨‹
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VueæŠ€æœ¯æ­ç§˜
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/book-docs/react-analysis/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·æˆé•¿
</a></div><div class="nav-item"><a href="https://ke.segmentfault.com/course/1650000023864436" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ”¥ è§†é¢‘è¯¾ç¨‹
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VueæŠ€æœ¯æ­ç§˜
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/book-docs/react-analysis/" aria-current="page" class="sidebar-link">å‰è¨€</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç†å¿µç¯‡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ¶æ„ç¯‡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å®ç°ç¯‡</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ç¬¬äº”ç«  Diffç®—æ³•</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ç¬¬å…­ç«  çŠ¶æ€æ›´æ–°</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>ç¬¬ä¸ƒç«  Hooks</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book-docs/react-analysis/hooks/prepare.html" class="sidebar-link">Hooksç†å¿µ</a></li><li><a href="/book-docs/react-analysis/hooks/create.html" class="sidebar-link">æç®€Hookså®ç°</a></li><li><a href="/book-docs/react-analysis/hooks/structure.html" class="sidebar-link">Hooksæ•°æ®ç»“æ„</a></li><li><a href="/book-docs/react-analysis/hooks/usestate.html" aria-current="page" class="active sidebar-link">useStateä¸useReducer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book-docs/react-analysis/hooks/usestate.html#æµç¨‹æ¦‚è§ˆ" class="sidebar-link">æµç¨‹æ¦‚è§ˆ</a></li><li class="sidebar-sub-header"><a href="/book-docs/react-analysis/hooks/usestate.html#å£°æ˜é˜¶æ®µ" class="sidebar-link">å£°æ˜é˜¶æ®µ</a></li><li class="sidebar-sub-header"><a href="/book-docs/react-analysis/hooks/usestate.html#è°ƒç”¨é˜¶æ®µ" class="sidebar-link">è°ƒç”¨é˜¶æ®µ</a></li><li class="sidebar-sub-header"><a href="/book-docs/react-analysis/hooks/usestate.html#å°tip" class="sidebar-link">å°Tip</a></li></ul></li><li><a href="/book-docs/react-analysis/hooks/useeffect.html" class="sidebar-link">useEffect</a></li><li><a href="/book-docs/react-analysis/hooks/useref.html" class="sidebar-link">useRef</a></li><li><a href="/book-docs/react-analysis/hooks/usememo.html" class="sidebar-link">useMemoä¸useCallback</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ç¬¬å…«ç«  Concurrent Mode</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><code>Redux</code>çš„ä½œè€…<code>Dan</code>åŠ å…¥<code>React</code>æ ¸å¿ƒå›¢é˜Ÿåçš„ä¸€å¤§è´¡çŒ®å°±æ˜¯â€œå°†<code>Redux</code>çš„ç†å¿µå¸¦å…¥<code>React</code>â€ã€‚</p> <p>è¿™é‡Œé¢æœ€æ˜¾è€Œæ˜“è§çš„å½±å“è«è¿‡äº<code>useState</code>ä¸<code>useReducer</code>è¿™ä¸¤ä¸ª<code>Hook</code>ã€‚æœ¬è´¨æ¥è¯´ï¼Œ<code>useState</code>åªæ˜¯é¢„ç½®äº†<code>reducer</code>çš„<code>useReducer</code>ã€‚</p> <p>æœ¬èŠ‚æˆ‘ä»¬æ¥å­¦ä¹ <code>useState</code>ä¸<code>useReducer</code>çš„å®ç°ã€‚</p> <h2 id="æµç¨‹æ¦‚è§ˆ"><a href="#æµç¨‹æ¦‚è§ˆ" class="header-anchor">#</a> æµç¨‹æ¦‚è§ˆ</h2> <p>æˆ‘ä»¬å°†è¿™ä¸¤ä¸ª<code>Hook</code>çš„å·¥ä½œæµç¨‹åˆ†ä¸º<code>å£°æ˜é˜¶æ®µ</code>å’Œ<code>è°ƒç”¨é˜¶æ®µ</code>ï¼Œå¯¹äºï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>a<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>  
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>  
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>å£°æ˜é˜¶æ®µ</code>å³<code>App</code>è°ƒç”¨æ—¶ï¼Œä¼šä¾æ¬¡æ‰§è¡Œ<code>useReducer</code>ä¸<code>useState</code>æ–¹æ³•ã€‚</p> <p><code>è°ƒç”¨é˜¶æ®µ</code>å³ç‚¹å‡»æŒ‰é’®åï¼Œ<code>dispatch</code>æˆ–<code>updateNum</code>è¢«è°ƒç”¨æ—¶ã€‚</p> <h2 id="å£°æ˜é˜¶æ®µ"><a href="#å£°æ˜é˜¶æ®µ" class="header-anchor">#</a> å£°æ˜é˜¶æ®µ</h2> <p>å½“<code>FunctionComponent</code>è¿›å…¥<code>renderé˜¶æ®µ</code>çš„<code>beginWork</code>æ—¶ï¼Œä¼šè°ƒç”¨<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L1419" target="_blank" rel="noopener noreferrer">renderWithHooks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>æ–¹æ³•ã€‚</p> <p>è¯¥æ–¹æ³•å†…éƒ¨ä¼šæ‰§è¡Œ<code>FunctionComponent</code>å¯¹åº”å‡½æ•°ï¼ˆå³<code>fiber.type</code>ï¼‰ã€‚</p> <blockquote><p>ä½ å¯ä»¥åœ¨<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L415" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>çœ‹åˆ°è¿™æ®µé€»è¾‘</p></blockquote> <p>å¯¹äºè¿™ä¸¤ä¸ª<code>Hook</code>ï¼Œä»–ä»¬çš„æºç å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">useReducer</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initialArg<span class="token punctuation">,</span> init</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialArg<span class="token punctuation">,</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ­£å¦‚ä¸Šä¸€èŠ‚<a href="/book-docs/react-analysis/hooks/structure.html#dispatcher">dispatcher</a>æ‰€è¯´ï¼Œåœ¨ä¸åŒåœºæ™¯ä¸‹ï¼ŒåŒä¸€ä¸ª<code>Hook</code>ä¼šè°ƒç”¨ä¸åŒå¤„ç†å‡½æ•°ã€‚</p> <p>æˆ‘ä»¬åˆ†åˆ«è®²è§£<code>mount</code>ä¸<code>update</code>ä¸¤ä¸ªåœºæ™¯ã€‚</p> <h3 id="mountæ—¶"><a href="#mountæ—¶" class="header-anchor">#</a> mountæ—¶</h3> <p><code>mount</code>æ—¶ï¼Œ<code>useReducer</code>ä¼šè°ƒç”¨<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L638" target="_blank" rel="noopener noreferrer">mountReducer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œ<code>useState</code>ä¼šè°ƒç”¨<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1143" target="_blank" rel="noopener noreferrer">mountState<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚</p> <p>æˆ‘ä»¬æ¥ç®€å•å¯¹æ¯”è¿™è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> mountState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  initialState<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºå¹¶è¿”å›å½“å‰çš„hook</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...èµ‹å€¼åˆå§‹state</span>

  <span class="token comment">// åˆ›å»ºqueue</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span>
    pending<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    dispatch<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    lastRenderedReducer<span class="token operator">:</span> basicStateReducer<span class="token punctuation">,</span>
    lastRenderedState<span class="token operator">:</span> <span class="token punctuation">(</span>initialState<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...åˆ›å»ºdispatch</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> mountReducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">I</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token function-variable function">reducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
  initialArg<span class="token operator">:</span> <span class="token constant">I</span><span class="token punctuation">,</span>
  init<span class="token operator">?</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">I</span></span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºå¹¶è¿”å›å½“å‰çš„hook</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...èµ‹å€¼åˆå§‹state</span>

  <span class="token comment">// åˆ›å»ºqueue</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span>
    pending<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    dispatch<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    lastRenderedReducer<span class="token operator">:</span> reducer<span class="token punctuation">,</span>
    lastRenderedState<span class="token operator">:</span> <span class="token punctuation">(</span>initialState<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...åˆ›å»ºdispatch</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å…¶ä¸­<code>mountWorkInProgressHook</code>æ–¹æ³•ä¼šåˆ›å»ºå¹¶è¿”å›å¯¹åº”<code>hook</code>ï¼Œå¯¹åº”<code>æç®€Hookså®ç°</code>ä¸­<code>useState</code>æ–¹æ³•çš„<code>isMount</code>é€»è¾‘éƒ¨åˆ†ã€‚</p> <p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>mount</code>æ—¶è¿™ä¸¤ä¸ª<code>Hook</code>çš„å”¯ä¸€åŒºåˆ«ä¸º<code>queue</code>å‚æ•°çš„<code>lastRenderedReducer</code>å­—æ®µã€‚</p> <p><code>queue</code>çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸æç®€å®ç°ä¸­çš„åŒåå­—æ®µæ„ä¹‰ç›¸åŒï¼Œä¿å­˜updateå¯¹è±¡</span>
  pending<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// ä¿å­˜dispatchAction.bind()çš„å€¼</span>
  dispatch<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// ä¸Šä¸€æ¬¡renderæ—¶ä½¿ç”¨çš„reducer</span>
  lastRenderedReducer<span class="token operator">:</span> reducer<span class="token punctuation">,</span>
  <span class="token comment">// ä¸Šä¸€æ¬¡renderæ—¶çš„state</span>
  lastRenderedState<span class="token operator">:</span> <span class="token punctuation">(</span>initialState<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å…¶ä¸­ï¼Œ<code>useReducer</code>çš„<code>lastRenderedReducer</code>ä¸ºä¼ å…¥çš„<code>reducer</code>å‚æ•°ã€‚<code>useState</code>çš„<code>lastRenderedReducer</code>ä¸º<code>basicStateReducer</code>ã€‚</p> <p><code>basicStateReducer</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> basicStateReducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token constant">S</span><span class="token punctuation">,</span> action<span class="token operator">:</span> BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">S</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">:</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯è§ï¼Œ<code>useState</code>å³<code>reducer</code>å‚æ•°ä¸º<code>basicStateReducer</code>çš„<code>useReducer</code>ã€‚</p> <p><code>mount</code>æ—¶çš„æ•´ä½“è¿è¡Œé€»è¾‘ä¸<code>æç®€å®ç°</code>çš„<code>isMount</code>é€»è¾‘ç±»ä¼¼ï¼Œä½ å¯ä»¥å¯¹ç…§ç€çœ‹ã€‚</p> <h3 id="updateæ—¶"><a href="#updateæ—¶" class="header-anchor">#</a> updateæ—¶</h3> <p>å¦‚æœè¯´<code>mount</code>æ—¶è¿™ä¸¤è€…è¿˜æœ‰åŒºåˆ«ï¼Œé‚£<code>update</code>æ—¶ï¼Œ<code>useReducer</code>ä¸<code>useState</code>è°ƒç”¨çš„åˆ™æ˜¯åŒä¸€ä¸ªå‡½æ•°<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L665" target="_blank" rel="noopener noreferrer">updateReducer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> updateReducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">I</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token function-variable function">reducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
  initialArg<span class="token operator">:</span> <span class="token constant">I</span><span class="token punctuation">,</span>
  init<span class="token operator">?</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">I</span></span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–å½“å‰hook</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">;</span>
  
  queue<span class="token punctuation">.</span>lastRenderedReducer <span class="token operator">=</span> reducer<span class="token punctuation">;</span>

  <span class="token comment">// ...åŒupdateä¸updateQueueç±»ä¼¼çš„æ›´æ–°é€»è¾‘</span>

  <span class="token keyword">const</span> dispatch<span class="token operator">:</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ•´ä¸ªæµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€å¥è¯ï¼š</p> <blockquote><p>æ‰¾åˆ°å¯¹åº”çš„<code>hook</code>ï¼Œæ ¹æ®<code>update</code>è®¡ç®—è¯¥<code>hook</code>çš„æ–°<code>state</code>å¹¶è¿”å›ã€‚</p></blockquote> <p><code>mount</code>æ—¶è·å–å½“å‰<code>hook</code>ä½¿ç”¨çš„æ˜¯<code>mountWorkInProgressHook</code>ï¼Œè€Œ<code>update</code>æ—¶ä½¿ç”¨çš„æ˜¯<code>updateWorkInProgressHook</code>ï¼Œè¿™é‡Œçš„åŸå› æ˜¯ï¼š</p> <ul><li><p><code>mount</code>æ—¶å¯ä»¥ç¡®å®šæ˜¯è°ƒç”¨<code>ReactDOM.render</code>æˆ–ç›¸å…³åˆå§‹åŒ–<code>API</code>äº§ç”Ÿçš„<code>æ›´æ–°</code>ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</p></li> <li><p><code>update</code>å¯èƒ½æ˜¯åœ¨äº‹ä»¶å›è°ƒæˆ–å‰¯ä½œç”¨ä¸­è§¦å‘çš„<code>æ›´æ–°</code>æˆ–è€…æ˜¯<code>renderé˜¶æ®µ</code>è§¦å‘çš„<code>æ›´æ–°</code>ï¼Œä¸ºäº†é¿å…ç»„ä»¶æ— é™å¾ªç¯<code>æ›´æ–°</code>ï¼Œåè€…éœ€è¦åŒºåˆ«å¯¹å¾…ã€‚</p></li></ul> <p>ä¸¾ä¸ª<code>renderé˜¶æ®µ</code>è§¦å‘çš„<code>æ›´æ–°</code>çš„ä¾‹å­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">updateNum</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>  
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>App</code>è°ƒç”¨æ—¶ï¼Œä»£è¡¨å·²ç»è¿›å…¥<code>renderé˜¶æ®µ</code>æ‰§è¡Œ<code>renderWithHooks</code>ã€‚</p> <p>åœ¨<code>App</code>å†…éƒ¨ï¼Œè°ƒç”¨<code>updateNum</code>ä¼šè§¦å‘ä¸€æ¬¡<code>æ›´æ–°</code>ã€‚å¦‚æœä¸å¯¹è¿™ç§æƒ…å†µä¸‹è§¦å‘çš„æ›´æ–°ä½œå‡ºé™åˆ¶ï¼Œé‚£ä¹ˆè¿™æ¬¡<code>æ›´æ–°</code>ä¼šå¼€å¯ä¸€æ¬¡æ–°çš„<code>renderé˜¶æ®µ</code>ï¼Œæœ€ç»ˆä¼šæ— é™å¾ªç¯æ›´æ–°ã€‚</p> <p>åŸºäºè¿™ä¸ªåŸå› ï¼Œ<code>React</code>ç”¨ä¸€ä¸ªæ ‡è®°å˜é‡<code>didScheduleRenderPhaseUpdate</code>åˆ¤æ–­æ˜¯å¦æ˜¯<code>renderé˜¶æ®µ</code>è§¦å‘çš„æ›´æ–°ã€‚</p> <p><code>updateWorkInProgressHook</code>æ–¹æ³•ä¹Ÿä¼šåŒºåˆ†è¿™ä¸¤ç§æƒ…å†µæ¥è·å–å¯¹åº”<code>hook</code>ã€‚</p> <p>è·å–å¯¹åº”<code>hook</code>ï¼Œæ¥ä¸‹æ¥ä¼šæ ¹æ®<code>hook</code>ä¸­ä¿å­˜çš„<code>state</code>è®¡ç®—æ–°çš„<code>state</code>ï¼Œè¿™ä¸ªæ­¥éª¤åŒ<a href="/book-docs/react-analysis/state/update.html">Updateä¸€èŠ‚</a>ä¸€è‡´ã€‚</p> <h2 id="è°ƒç”¨é˜¶æ®µ"><a href="#è°ƒç”¨é˜¶æ®µ" class="header-anchor">#</a> è°ƒç”¨é˜¶æ®µ</h2> <p>è°ƒç”¨é˜¶æ®µä¼šæ‰§è¡Œ<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1662" target="_blank" rel="noopener noreferrer">dispatchAction<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼Œæ­¤æ—¶è¯¥<code>FunctionComponent</code>å¯¹åº”çš„<code>fiber</code>ä»¥åŠ<code>hook.queue</code>å·²ç»é€šè¿‡è°ƒç”¨<code>bind</code>æ–¹æ³•é¢„å…ˆä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// ...åˆ›å»ºupdate</span>
  <span class="token keyword">var</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
    eventTime<span class="token operator">:</span> eventTime<span class="token punctuation">,</span>
    lane<span class="token operator">:</span> lane<span class="token punctuation">,</span>
    suspenseConfig<span class="token operator">:</span> suspenseConfig<span class="token punctuation">,</span>
    action<span class="token operator">:</span> action<span class="token punctuation">,</span>
    eagerReducer<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    eagerState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> 

  <span class="token comment">// ...å°†updateåŠ å…¥queue.pending</span>
  
  <span class="token keyword">var</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber <span class="token operator">===</span> currentlyRenderingFiber$<span class="token number">1</span> <span class="token operator">||</span> alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> alternate <span class="token operator">===</span> currentlyRenderingFiber$<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// renderé˜¶æ®µè§¦å‘çš„æ›´æ–°</span>
    didScheduleRenderPhaseUpdateDuringThisPass <span class="token operator">=</span> didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>lanes <span class="token operator">===</span> NoLanes <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>lanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...fiberçš„updateQueueä¸ºç©ºï¼Œä¼˜åŒ–è·¯å¾„</span>
    <span class="token punctuation">}</span>

    <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ•´ä¸ªè¿‡ç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š</p> <blockquote><p>åˆ›å»º<code>update</code>ï¼Œå°†<code>update</code>åŠ å…¥<code>queue.pending</code>ä¸­ï¼Œå¹¶å¼€å¯è°ƒåº¦ã€‚</p></blockquote> <p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯<code>if...else...</code>é€»è¾‘ï¼Œå…¶ä¸­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>fiber <span class="token operator">===</span> currentlyRenderingFiber$<span class="token number">1</span> <span class="token operator">||</span> alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> alternate <span class="token operator">===</span> currentlyRenderingFiber$<span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p><code>currentlyRenderingFiber</code>å³<code>workInProgress</code>ï¼Œ<code>workInProgress</code>å­˜åœ¨ä»£è¡¨å½“å‰å¤„äº<code>renderé˜¶æ®µ</code>ã€‚</p> <p>è§¦å‘<code>æ›´æ–°</code>æ—¶é€šè¿‡<code>bind</code>é¢„å…ˆä¿å­˜çš„<code>fiber</code>ä¸<code>workInProgress</code>å…¨ç­‰ï¼Œä»£è¡¨æœ¬æ¬¡<code>æ›´æ–°</code>å‘ç”Ÿäº<code>FunctionComponent</code>å¯¹åº”<code>fiber</code>çš„<code>renderé˜¶æ®µ</code>ã€‚</p> <p>æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ª<code>renderé˜¶æ®µ</code>è§¦å‘çš„<code>æ›´æ–°</code>ï¼Œéœ€è¦æ ‡è®°å˜é‡<code>didScheduleRenderPhaseUpdate</code>ï¼Œåç»­å•ç‹¬å¤„ç†ã€‚</p> <p>å†æ¥å…³æ³¨ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>lanes <span class="token operator">===</span> NoLanes <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>lanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><code>fiber.lanes</code>ä¿å­˜<code>fiber</code>ä¸Šå­˜åœ¨çš„<code>update</code>çš„<code>ä¼˜å…ˆçº§</code>ã€‚</p> <p><code>fiber.lanes === NoLanes</code>æ„å‘³ç€<code>fiber</code>ä¸Šä¸å­˜åœ¨<code>update</code>ã€‚</p> <p>æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œé€šè¿‡<code>update</code>è®¡ç®—<code>state</code>å‘ç”Ÿåœ¨<code>å£°æ˜é˜¶æ®µ</code>ï¼Œè¿™æ˜¯å› ä¸ºè¯¥<code>hook</code>ä¸Šå¯èƒ½å­˜åœ¨å¤šä¸ªä¸åŒ<code>ä¼˜å…ˆçº§</code>çš„<code>update</code>ï¼Œæœ€ç»ˆ<code>state</code>çš„å€¼ç”±å¤šä¸ª<code>update</code>å…±åŒå†³å®šã€‚</p> <p>ä½†æ˜¯å½“<code>fiber</code>ä¸Šä¸å­˜åœ¨<code>update</code>ï¼Œåˆ™<code>è°ƒç”¨é˜¶æ®µ</code>åˆ›å»ºçš„<code>update</code>ä¸ºè¯¥<code>hook</code>ä¸Šç¬¬ä¸€ä¸ª<code>update</code>ï¼Œåœ¨<code>å£°æ˜é˜¶æ®µ</code>è®¡ç®—<code>state</code>æ—¶ä¹Ÿåªä¾èµ–äºè¯¥<code>update</code>ï¼Œå®Œå…¨ä¸éœ€è¦è¿›å…¥<code>å£°æ˜é˜¶æ®µ</code>å†è®¡ç®—<code>state</code>ã€‚</p> <p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šå¦‚æœè®¡ç®—å‡ºçš„<code>state</code>ä¸è¯¥<code>hook</code>ä¹‹å‰ä¿å­˜çš„<code>state</code>ä¸€è‡´ï¼Œé‚£ä¹ˆå®Œå…¨ä¸éœ€è¦å¼€å¯ä¸€æ¬¡è°ƒåº¦ã€‚å³ä½¿è®¡ç®—å‡ºçš„<code>state</code>ä¸è¯¥<code>hook</code>ä¹‹å‰ä¿å­˜çš„<code>state</code>ä¸ä¸€è‡´ï¼Œåœ¨<code>å£°æ˜é˜¶æ®µ</code>ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨<code>è°ƒç”¨é˜¶æ®µ</code>å·²ç»è®¡ç®—å‡ºçš„<code>state</code>ã€‚</p> <blockquote><p>ä½ å¯ä»¥åœ¨<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1727" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>çœ‹åˆ°è¿™æ®µæå‰è®¡ç®—<code>state</code>çš„é€»è¾‘</p></blockquote> <h2 id="å°tip"><a href="#å°tip" class="header-anchor">#</a> å°Tip</h2> <p>æˆ‘ä»¬é€šå¸¸è®¤ä¸ºï¼Œ<code>useReducer(reducer, initialState)</code>çš„ä¼ å‚ä¸ºåˆå§‹åŒ–å‚æ•°ï¼Œåœ¨ä»¥åçš„è°ƒç”¨ä¸­éƒ½ä¸å¯å˜ã€‚</p> <p>ä½†æ˜¯åœ¨<code>updateReducer</code>æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°<code>lastRenderedReducer</code>åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¼šé‡æ–°èµ‹å€¼ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initialArg<span class="token punctuation">,</span> init</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  queue<span class="token punctuation">.</span>lastRenderedReducer <span class="token operator">=</span> reducer<span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>reducer</code>å‚æ•°æ˜¯éšæ—¶å¯å˜çš„ã€‚</p> <details class="custom-block details"><summary>reducerå¯å˜Demo</summary> <p>æ¯ç§’<code>useReducer</code>ä½¿ç”¨çš„<code>reducer</code>ä¼šæ”¹å˜ä¸€æ¬¡</p> <p>ç‚¹å‡»æŒ‰é’®åä¼šéšæ—¶é—´ä¸åŒä¼šå‡ºç°<code>+1</code>æˆ–<code>-1</code>çš„æ•ˆæœ</p> <p><a href="/book-docs/react-analysis/me.html">å…³æ³¨å…¬ä¼—å·</a>ï¼Œåå°å›å¤<strong>582</strong>è·å¾—åœ¨çº¿Demoåœ°å€</p></details></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/BetaSu/just-react/edit/master/docs/hooks/usestate.md" target="_blank" rel="noopener noreferrer">ä¸ºè¯¥ç« èŠ‚çº é”™</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">5/29/2021, 4:18:57 PM</span></div></footer> <div><div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/book-docs/react-analysis/hooks/structure.html" class="prev">
        Hooksæ•°æ®ç»“æ„
      </a></span> <span class="next"><a href="/book-docs/react-analysis/hooks/useeffect.html">
        useEffect
      </a>
      â†’
    </span></p></div> <div class="icp-footer"><p>CopyrightÂ© 2020-2021 å¡é¢‚</p> <a href="https://beian.miit.gov.cn/" target="_blank">äº¬ICPå¤‡20028082å·-1</a></div></div> </main></div><div class="global-ui"></div></div>
    <script src="/book-docs/react-analysis/assets/js/app.c42aa1da.js" defer></script><script src="/book-docs/react-analysis/assets/js/2.ab464fc7.js" defer></script><script src="/book-docs/react-analysis/assets/js/22.b2320cf7.js" defer></script><script src="/book-docs/react-analysis/assets/js/3.bd8ee395.js" defer></script>
  </body>
</html>
