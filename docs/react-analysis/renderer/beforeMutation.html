<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ReactæŠ€æœ¯æ­ç§˜</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script src="/book-docs/react-analysis/assets/js/tj.js"></script>
    <meta name="description" content="Reactæºç è§£æ">
    
    <link rel="preload" href="/book-docs/react-analysis/assets/css/0.styles.6b071643.css" as="style"><link rel="preload" href="/book-docs/react-analysis/assets/js/app.c42aa1da.js" as="script"><link rel="preload" href="/book-docs/react-analysis/assets/js/2.ab464fc7.js" as="script"><link rel="preload" href="/book-docs/react-analysis/assets/js/38.fb4713ce.js" as="script"><link rel="preload" href="/book-docs/react-analysis/assets/js/3.bd8ee395.js" as="script"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/10.fbded8cf.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/11.289d6c66.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/12.870f191a.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/13.59b0cb7d.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/14.cd758e90.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/15.a09ba33a.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/16.e6edbb6b.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/17.cf66438c.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/18.fb23468a.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/19.25703c84.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/20.eda559ea.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/21.cab6e748.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/22.b2320cf7.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/23.73c35c9d.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/24.efc917a9.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/25.e370ed97.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/26.ab0676c9.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/27.e498bc4f.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/28.4216510f.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/29.ef001e90.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/30.df8ec67b.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/31.3e3297f8.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/32.cf12efa8.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/33.266eee65.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/34.29e02a4a.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/35.75411d8e.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/36.0f9c40b9.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/37.5980d866.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/39.b35cc2fa.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/4.c6061572.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/40.951223e3.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/41.7f455382.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/42.16854cf0.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/43.ca836c33.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/44.9689a8a2.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/45.ab80d190.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/46.ea324e2d.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/47.f5e188fc.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/5.8e19291d.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/6.311ac735.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/7.74392417.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/8.42267bd5.js"><link rel="prefetch" href="/book-docs/react-analysis/assets/js/9.84e8a951.js">
    <link rel="stylesheet" href="/book-docs/react-analysis/assets/css/0.styles.6b071643.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/book-docs/react-analysis/" class="home-link router-link-active"><!----> <span class="site-name">ReactæŠ€æœ¯æ­ç§˜</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/book-docs/react-analysis/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·æˆé•¿
</a></div><div class="nav-item"><a href="https://ke.segmentfault.com/course/1650000023864436" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ”¥ è§†é¢‘è¯¾ç¨‹
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VueæŠ€æœ¯æ­ç§˜
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/book-docs/react-analysis/me.html" class="nav-link">
  ğŸ™‹â€â™‚ï¸ ä¸€èµ·æˆé•¿
</a></div><div class="nav-item"><a href="https://ke.segmentfault.com/course/1650000023864436" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ”¥ è§†é¢‘è¯¾ç¨‹
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VueæŠ€æœ¯æ­ç§˜
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    ç‚¹äº®â­ä¸è¿·è·¯
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/book-docs/react-analysis/" aria-current="page" class="sidebar-link">å‰è¨€</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ç†å¿µç¯‡</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>æ¶æ„ç¯‡</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ç¬¬ä¸‰ç«  renderé˜¶æ®µ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>ç¬¬å››ç«  commité˜¶æ®µ</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book-docs/react-analysis/renderer/prepare.html" class="sidebar-link">æµç¨‹æ¦‚è§ˆ</a></li><li><a href="/book-docs/react-analysis/renderer/beforeMutation.html" aria-current="page" class="active sidebar-link">before mutationé˜¶æ®µ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book-docs/react-analysis/renderer/beforeMutation.html#æ¦‚è§ˆ" class="sidebar-link">æ¦‚è§ˆ</a></li><li class="sidebar-sub-header"><a href="/book-docs/react-analysis/renderer/beforeMutation.html#commitbeforemutationeffects" class="sidebar-link">commitBeforeMutationEffects</a></li><li class="sidebar-sub-header"><a href="/book-docs/react-analysis/renderer/beforeMutation.html#è°ƒç”¨getsnapshotbeforeupdate" class="sidebar-link">è°ƒç”¨getSnapshotBeforeUpdate</a></li><li class="sidebar-sub-header"><a href="/book-docs/react-analysis/renderer/beforeMutation.html#è°ƒåº¦useeffect" class="sidebar-link">è°ƒåº¦useEffect</a></li><li class="sidebar-sub-header"><a href="/book-docs/react-analysis/renderer/beforeMutation.html#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li><li><a href="/book-docs/react-analysis/renderer/mutation.html" class="sidebar-link">mutationé˜¶æ®µ</a></li><li><a href="/book-docs/react-analysis/renderer/layout.html" class="sidebar-link">layouté˜¶æ®µ</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å®ç°ç¯‡</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>åœ¨æœ¬èŠ‚æ­£å¼å¼€å§‹å‰ï¼Œè®©æˆ‘ä»¬å¤ä¹ ä¸‹è¿™ä¸€ç« åˆ°ç›®å‰ä¸ºæ­¢æ‰€å­¦çš„ã€‚</p> <p><code>Renderer</code>å·¥ä½œçš„é˜¶æ®µè¢«ç§°ä¸º<code>commit</code>é˜¶æ®µã€‚<code>commit</code>é˜¶æ®µå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼š</p> <ul><li><p>before mutationé˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œå‰ï¼‰</p></li> <li><p>mutationé˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œï¼‰</p></li> <li><p>layouté˜¶æ®µï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œåï¼‰</p></li></ul> <p>æœ¬èŠ‚æˆ‘ä»¬çœ‹çœ‹<code>before mutationé˜¶æ®µ</code>ï¼ˆæ‰§è¡Œ<code>DOM</code>æ“ä½œå‰ï¼‰éƒ½åšäº†ä»€ä¹ˆã€‚</p> <h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="header-anchor">#</a> æ¦‚è§ˆ</h2> <p><code>before mutationé˜¶æ®µ</code>çš„ä»£ç å¾ˆçŸ­ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯éå†<code>effectList</code>å¹¶è°ƒç”¨<code>commitBeforeMutationEffects</code>å‡½æ•°å¤„ç†ã€‚</p> <blockquote><p>è¿™éƒ¨åˆ†<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2104-L2127" target="_blank" rel="noopener noreferrer">æºç åœ¨è¿™é‡Œ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚ä¸ºäº†å¢åŠ å¯è¯»æ€§ï¼Œç¤ºä¾‹ä»£ç ä¸­åˆ é™¤äº†ä¸ç›¸å…³çš„é€»è¾‘</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ä¿å­˜ä¹‹å‰çš„ä¼˜å…ˆçº§ï¼Œä»¥åŒæ­¥ä¼˜å…ˆçº§æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åæ¢å¤ä¹‹å‰ä¼˜å…ˆçº§</span>
<span class="token keyword">const</span> previousLanePriority <span class="token operator">=</span> <span class="token function">getCurrentUpdateLanePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setCurrentUpdateLanePriority</span><span class="token punctuation">(</span>SyncLanePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å°†å½“å‰ä¸Šä¸‹æ–‡æ ‡è®°ä¸ºCommitContextï¼Œä½œä¸ºcommité˜¶æ®µçš„æ ‡å¿—</span>
<span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
executionContext <span class="token operator">|=</span> CommitContext<span class="token punctuation">;</span>

<span class="token comment">// å¤„ç†focusçŠ¶æ€</span>
focusedInstanceHandle <span class="token operator">=</span> <span class="token function">prepareForCommit</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
shouldFireAfterActiveInstanceBlur <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// beforeMutationé˜¶æ®µçš„ä¸»å‡½æ•°</span>
<span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>

focusedInstanceHandle <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre></div><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨<code>beforeMutation</code>é˜¶æ®µçš„ä¸»å‡½æ•°<code>commitBeforeMutationEffects</code>åšäº†ä»€ä¹ˆã€‚</p> <h2 id="commitbeforemutationeffects"><a href="#commitbeforemutationeffects" class="header-anchor">#</a> commitBeforeMutationEffects</h2> <p>å¤§ä½“ä»£ç é€»è¾‘ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldFireAfterActiveInstanceBlur <span class="token operator">&amp;&amp;</span> focusedInstanceHandle <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...focus blurç›¸å…³</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>

    <span class="token comment">// è°ƒç”¨getSnapshotBeforeUpdate</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è°ƒåº¦useEffect</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ•´ä½“å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p> <ol><li><p>å¤„ç†<code>DOMèŠ‚ç‚¹</code>æ¸²æŸ“/åˆ é™¤åçš„ <code>autoFocus</code>ã€<code>blur</code> é€»è¾‘ã€‚</p></li> <li><p>è°ƒç”¨<code>getSnapshotBeforeUpdate</code>ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚</p></li> <li><p>è°ƒåº¦<code>useEffect</code>ã€‚</p></li></ol> <p>æˆ‘ä»¬è®²è§£ä¸‹2ã€3ä¸¤ç‚¹ã€‚</p> <h2 id="è°ƒç”¨getsnapshotbeforeupdate"><a href="#è°ƒç”¨getsnapshotbeforeupdate" class="header-anchor">#</a> è°ƒç”¨getSnapshotBeforeUpdate</h2> <p><code>commitBeforeMutationEffectOnFiber</code>æ˜¯<code>commitBeforeMutationLifeCycles</code>çš„åˆ«åã€‚</p> <p>åœ¨è¯¥æ–¹æ³•å†…ä¼šè°ƒç”¨<code>getSnapshotBeforeUpdate</code>ã€‚</p> <blockquote><p>ä½ å¯ä»¥åœ¨<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L222" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>çœ‹åˆ°è¿™æ®µé€»è¾‘</p></blockquote> <p>ä»<code>React</code>v16å¼€å§‹ï¼Œ<code>componentWillXXX</code>é’©å­å‰å¢åŠ äº†<code>UNSAFE_</code>å‰ç¼€ã€‚</p> <p>ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸º<code>Stack Reconciler</code>é‡æ„ä¸º<code>Fiber Reconciler</code>åï¼Œ<code>renderé˜¶æ®µ</code>çš„ä»»åŠ¡å¯èƒ½ä¸­æ–­/é‡æ–°å¼€å§‹ï¼Œå¯¹åº”çš„ç»„ä»¶åœ¨<code>renderé˜¶æ®µ</code>çš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå³<code>componentWillXXX</code>ï¼‰å¯èƒ½è§¦å‘å¤šæ¬¡ã€‚</p> <p>è¿™ç§è¡Œä¸ºå’Œ<code>React</code>v15ä¸ä¸€è‡´ï¼Œæ‰€ä»¥æ ‡è®°ä¸º<code>UNSAFE_</code>ã€‚</p> <blockquote><p>æ›´è¯¦ç»†çš„è§£é‡Šå‚ç…§<a href="https://juejin.im/post/6847902224287285255#comment" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>ä¸ºæ­¤ï¼Œ<code>React</code>æä¾›äº†æ›¿ä»£çš„ç”Ÿå‘½å‘¨æœŸé’©å­<code>getSnapshotBeforeUpdate</code>ã€‚</p> <p>æˆ‘ä»¬å¯ä»¥çœ‹è§ï¼Œ<code>getSnapshotBeforeUpdate</code>æ˜¯åœ¨<code>commité˜¶æ®µ</code>å†…çš„<code>before mutationé˜¶æ®µ</code>è°ƒç”¨çš„ï¼Œç”±äº<code>commité˜¶æ®µ</code>æ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥ä¸ä¼šé‡åˆ°å¤šæ¬¡è°ƒç”¨çš„é—®é¢˜ã€‚</p> <h2 id="è°ƒåº¦useeffect"><a href="#è°ƒåº¦useeffect" class="header-anchor">#</a> è°ƒåº¦<code>useEffect</code></h2> <p>åœ¨è¿™å‡ è¡Œä»£ç å†…ï¼Œ<code>scheduleCallback</code>æ–¹æ³•ç”±<code>Scheduler</code>æ¨¡å—æä¾›ï¼Œç”¨äºä»¥æŸä¸ªä¼˜å…ˆçº§å¼‚æ­¥è°ƒåº¦ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è°ƒåº¦useEffect</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// è§¦å‘useEffect</span>
      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨æ­¤å¤„ï¼Œè¢«å¼‚æ­¥è°ƒåº¦çš„å›è°ƒå‡½æ•°å°±æ˜¯è§¦å‘<code>useEffect</code>çš„æ–¹æ³•<code>flushPassiveEffects</code>ã€‚</p> <p>æˆ‘ä»¬æ¥ä¸‹æ¥è®¨è®º<code>useEffect</code>å¦‚ä½•è¢«å¼‚æ­¥è°ƒåº¦ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦å¼‚æ­¥ï¼ˆè€Œä¸æ˜¯åŒæ­¥ï¼‰è°ƒåº¦ã€‚</p> <h3 id="å¦‚ä½•å¼‚æ­¥è°ƒåº¦"><a href="#å¦‚ä½•å¼‚æ­¥è°ƒåº¦" class="header-anchor">#</a> å¦‚ä½•å¼‚æ­¥è°ƒåº¦</h3> <p>åœ¨<code>flushPassiveEffects</code>æ–¹æ³•å†…éƒ¨ä¼šä»å…¨å±€å˜é‡<code>rootWithPendingPassiveEffects</code>è·å–<code>effectList</code>ã€‚</p> <p>å…³äº<code>flushPassiveEffects</code>çš„å…·ä½“è®²è§£å‚ç…§<a href="/book-docs/react-analysis/hooks/useeffect.html">useEffectä¸useLayoutEffectä¸€èŠ‚</a></p> <p>åœ¨<a href="/book-docs/react-analysis/process/completeWork.html#effectlist">completeWorkä¸€èŠ‚</a>æˆ‘ä»¬è®²åˆ°ï¼Œ<code>effectList</code>ä¸­ä¿å­˜äº†éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨çš„<code>FiberèŠ‚ç‚¹</code>ã€‚å…¶ä¸­å‰¯ä½œç”¨åŒ…æ‹¬</p> <ul><li>æ’å…¥<code>DOMèŠ‚ç‚¹</code>ï¼ˆPlacementï¼‰</li> <li>æ›´æ–°<code>DOMèŠ‚ç‚¹</code>ï¼ˆUpdateï¼‰</li> <li>åˆ é™¤<code>DOMèŠ‚ç‚¹</code>ï¼ˆDeletionï¼‰</li></ul> <p>é™¤æ­¤å¤–ï¼Œå½“ä¸€ä¸ª<code>FunctionComponent</code>å«æœ‰<code>useEffect</code>æˆ–<code>useLayoutEffect</code>ï¼Œä»–å¯¹åº”çš„<code>FiberèŠ‚ç‚¹</code>ä¹Ÿä¼šè¢«èµ‹å€¼<code>effectTag</code>ã€‚</p> <blockquote><p>ä½ å¯ä»¥ä»<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactHookEffectTags.js" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>çœ‹åˆ°<code>hook</code>ç›¸å…³çš„<code>effectTag</code></p></blockquote> <p>åœ¨<code>flushPassiveEffects</code>æ–¹æ³•å†…éƒ¨ä¼šéå†<code>rootWithPendingPassiveEffects</code>ï¼ˆå³<code>effectList</code>ï¼‰æ‰§è¡Œ<code>effect</code>å›è°ƒå‡½æ•°ã€‚</p> <p>å¦‚æœåœ¨æ­¤æ—¶ç›´æ¥æ‰§è¡Œï¼Œ<code>rootWithPendingPassiveEffects === null</code>ã€‚</p> <p>é‚£ä¹ˆ<code>rootWithPendingPassiveEffects</code>ä¼šåœ¨ä½•æ—¶èµ‹å€¼å‘¢ï¼Ÿ</p> <p>åœ¨ä¸Šä¸€èŠ‚<code>layoutä¹‹å</code>çš„ä»£ç ç‰‡æ®µä¸­ä¼šæ ¹æ®<code>rootDoesHavePassiveEffects === true?</code>å†³å®šæ˜¯å¦èµ‹å€¼<code>rootWithPendingPassiveEffects</code>ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> rootDidHavePassiveEffects <span class="token operator">=</span> rootDoesHavePassiveEffects<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  rootWithPendingPassiveEffects <span class="token operator">=</span> root<span class="token punctuation">;</span>
  pendingPassiveEffectsLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
  pendingPassiveEffectsRenderPriority <span class="token operator">=</span> renderPriorityLevel<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰€ä»¥æ•´ä¸ª<code>useEffect</code>å¼‚æ­¥è°ƒç”¨åˆ†ä¸ºä¸‰æ­¥ï¼š</p> <ol><li><code>before mutationé˜¶æ®µ</code>åœ¨<code>scheduleCallback</code>ä¸­è°ƒåº¦<code>flushPassiveEffects</code></li> <li><code>layouté˜¶æ®µ</code>ä¹‹åå°†<code>effectList</code>èµ‹å€¼ç»™<code>rootWithPendingPassiveEffects</code></li> <li><code>scheduleCallback</code>è§¦å‘<code>flushPassiveEffects</code>ï¼Œ<code>flushPassiveEffects</code>å†…éƒ¨éå†<code>rootWithPendingPassiveEffects</code></li></ol> <h3 id="ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥è°ƒç”¨"><a href="#ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥è°ƒç”¨" class="header-anchor">#</a> ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥è°ƒç”¨</h3> <p>æ‘˜å½•è‡ª<code>React</code>æ–‡æ¡£<a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#timing-of-effects" target="_blank" rel="noopener noreferrer">effect çš„æ‰§è¡Œæ—¶æœº<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ï¼š</p> <blockquote><p>ä¸ componentDidMountã€componentDidUpdate ä¸åŒçš„æ˜¯ï¼Œåœ¨æµè§ˆå™¨å®Œæˆå¸ƒå±€ä¸ç»˜åˆ¶ä¹‹åï¼Œä¼ ç»™ useEffect çš„å‡½æ•°ä¼šå»¶è¿Ÿè°ƒç”¨ã€‚è¿™ä½¿å¾—å®ƒé€‚ç”¨äºè®¸å¤šå¸¸è§çš„å‰¯ä½œç”¨åœºæ™¯ï¼Œæ¯”å¦‚è®¾ç½®è®¢é˜…å’Œäº‹ä»¶å¤„ç†ç­‰æƒ…å†µï¼Œå› æ­¤ä¸åº”åœ¨å‡½æ•°ä¸­æ‰§è¡Œé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•çš„æ“ä½œã€‚</p></blockquote> <p>å¯è§ï¼Œ<code>useEffect</code>å¼‚æ­¥æ‰§è¡Œçš„åŸå› ä¸»è¦æ˜¯é˜²æ­¢åŒæ­¥æ‰§è¡Œæ—¶é˜»å¡æµè§ˆå™¨æ¸²æŸ“ã€‚</p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>ç»è¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“äº†åœ¨<code>before mutationé˜¶æ®µ</code>ï¼Œä¼šéå†<code>effectList</code>ï¼Œä¾æ¬¡æ‰§è¡Œï¼š</p> <ol><li><p>å¤„ç†<code>DOMèŠ‚ç‚¹</code>æ¸²æŸ“/åˆ é™¤åçš„ <code>autoFocus</code>ã€<code>blur</code>é€»è¾‘</p></li> <li><p>è°ƒç”¨<code>getSnapshotBeforeUpdate</code>ç”Ÿå‘½å‘¨æœŸé’©å­</p></li> <li><p>è°ƒåº¦<code>useEffect</code></p></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/BetaSu/just-react/edit/master/docs/renderer/beforeMutation.md" target="_blank" rel="noopener noreferrer">ä¸ºè¯¥ç« èŠ‚çº é”™</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">8/21/2020, 12:11:16 PM</span></div></footer> <div><div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/book-docs/react-analysis/renderer/prepare.html" class="prev">
        æµç¨‹æ¦‚è§ˆ
      </a></span> <span class="next"><a href="/book-docs/react-analysis/renderer/mutation.html">
        mutationé˜¶æ®µ
      </a>
      â†’
    </span></p></div> <div class="icp-footer"><p>CopyrightÂ© 2020-2021 å¡é¢‚</p> <a href="https://beian.miit.gov.cn/" target="_blank">äº¬ICPå¤‡20028082å·-1</a></div></div> </main></div><div class="global-ui"></div></div>
    <script src="/book-docs/react-analysis/assets/js/app.c42aa1da.js" defer></script><script src="/book-docs/react-analysis/assets/js/2.ab464fc7.js" defer></script><script src="/book-docs/react-analysis/assets/js/38.fb4713ce.js" defer></script><script src="/book-docs/react-analysis/assets/js/3.bd8ee395.js" defer></script>
  </body>
</html>
