<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>技术文档</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="技术文档">
    
    <link rel="preload" href="/book-docs/vue-depth-analysis/assets/css/0.styles.aa1e90bd.css" as="style"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/app.186b0384.js" as="script"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/2.d669090a.js" as="script"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/11.b88ae913.js" as="script"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/10.7852d010.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/12.8d172228.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/13.ce31926b.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/14.967cef5e.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/15.635a9e78.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/16.746833fb.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/17.b5030f17.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/18.b41eb005.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/19.bb0ceb6c.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/20.e08a7e67.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/21.ceb288f7.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/22.f5a9ebe3.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/23.d95b6104.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/3.c431a2cd.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/4.b2e60800.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/5.17163f3d.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/6.bfaa3de2.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/7.1e431d66.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/8.b732416c.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/9.712a636c.js">
    <link rel="stylesheet" href="/book-docs/vue-depth-analysis/assets/css/0.styles.aa1e90bd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/book-docs/vue-depth-analysis/" class="home-link router-link-active"><!----> <span class="site-name">技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/book-docs/vue-depth-analysis/vue插槽，你想了解的都在这里.html" class="sidebar-link">vue插槽，你想了解的都在这里.md</a></li><li><a href="/book-docs/vue-depth-analysis/丰富的选项合并策略.html" class="sidebar-link">丰富的选项合并策略.md</a></li><li><a href="/book-docs/vue-depth-analysis/你真的了解v-model的语法糖了吗.html" class="sidebar-link">你真的了解v-model的语法糖了吗.md</a></li><li><a href="/book-docs/vue-depth-analysis/动态组件的深入分析.html" class="sidebar-link">动态组件的深入分析.md</a></li><li><a href="/book-docs/vue-depth-analysis/基础的数据代理检测.html" class="sidebar-link">基础的数据代理检测.md</a></li><li><a href="/book-docs/vue-depth-analysis/完整渲染流程.html" class="sidebar-link">完整渲染流程.md</a></li><li><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html" class="active sidebar-link">实例挂载流程和模板编译.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html#_3-1-runtime-only-vs-runtime-compiler" class="sidebar-link">3.1 Runtime Only VS Runtime + Compiler</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html#_3-2-实例挂载的基本思路" class="sidebar-link">3.2 实例挂载的基本思路</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html#_3-3-模板编译" class="sidebar-link">3.3 模板编译</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html#_3-3-1-template的三种写法" class="sidebar-link">3.3.1 template的三种写法</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html#_3-3-2-编译流程图解" class="sidebar-link">3.3.2 编译流程图解</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html#_3-3-3-逻辑解析" class="sidebar-link">3.3.3 逻辑解析</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html#_3-4-小结" class="sidebar-link">3.4 小结</a></li></ul></li><li><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html" class="sidebar-link">彻底搞懂Vue中keep-alive的魔法-上.md</a></li><li><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-下.html" class="sidebar-link">彻底搞懂Vue中keep-alive的魔法-下.md</a></li><li><a href="/book-docs/vue-depth-analysis/揭秘Vue的事件机制.html" class="sidebar-link">揭秘Vue的事件机制.md</a></li><li><a href="/book-docs/vue-depth-analysis/来，跟我一起实现diff算法.html" class="sidebar-link">来，跟我一起实现diff算法.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-上.html" class="sidebar-link">深入响应式系统构建-上.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-下.html" class="sidebar-link">深入响应式系统构建-下.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-中.html" class="sidebar-link">深入响应式系统构建-中.md</a></li><li><a href="/book-docs/vue-depth-analysis/组件基础剖析.html" class="sidebar-link">组件基础剖析.md</a></li><li><a href="/book-docs/vue-depth-analysis/组件高级用法.html" class="sidebar-link">组件高级用法.md</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>前面几节我们从<code>new Vue</code>创建实例开始，介绍了创建实例时执行初始化流程中的重要两步，配置选项的资源合并,以及响应式系统的核心思想，数据代理。在合并章节，我们对<code>Vue</code>丰富的选项合并策略有了基本的认知，在数据代理章节我们又对代理拦截的意义和使用场景有了深入的认识。按照<code>Vue</code>源码的设计思路，初始化过程还会进行很多操作，例如组件之间创建关联，初始化事件中心，初始化数据并建立响应式系统等，并最终将模板和数据渲染成为<code>dom</code>节点。如果直接按流程的先后顺序分析每个步骤的实现细节，会有很多概念很难理解。因此在这一章节，我们先重点分析一个概念，<strong>实例的挂载渲染流程。</strong></p></blockquote> <h2 id="_3-1-runtime-only-vs-runtime-compiler"><a href="#_3-1-runtime-only-vs-runtime-compiler" class="header-anchor">#</a> 3.1 Runtime Only VS Runtime + Compiler</h2> <p>在正文开始之前，我们先了解一下<code>vue</code>基于源码构建的两个版本，一个是<code>runtime only</code>(一个只包含运行时的版本)，另一个是<code>runtime + compiler</code>(一个同时包含编译器和运行时的版本)。而两个版本的区别仅在于后者包含了一个编译器。</p> <p>什么是编译器，百度百科这样解释道：</p> <blockquote><p>简单讲，编译器就是将“一种语言（通常为高级语言）”翻译为“另一种语言（通常为低级语言）”的程序。一个现代编译器的主要工作流程：源代码 (source code) → 预处理器 (preprocessor) → 编译器 (compiler) → 目标代码 (object code) → 链接器 (Linker) → 可执行程序 (executables)。</p></blockquote> <p>通俗点讲，编译器是一个提供了将<strong>源代码</strong>转化为<strong>目标代码</strong>的工具。从<code>Vue</code>的角度出发，内置的编译器实现了将<code>template</code>模板转换编译为可执行<code>javascript</code>脚本的功能。</p> <h3 id="_3-1-1-runtime-compiler"><a href="#_3-1-1-runtime-compiler" class="header-anchor">#</a> 3.1.1 Runtime + Compiler</h3> <p>一个完整的<code>Vue</code>版本是包含编译器的，我们可以使用<code>template</code>进行模板编写。编译器会自动将模板字符串编译成渲染函数的代码,源码中就是<code>render</code>函数。
如果你需要在客户端编译模板 (比如传入一个字符串给 <code>template</code> 选项，或挂载到一个元素上并以其 <code>DOM</code> 内部的 HTML 作为模板)，就需要一个包含编译器的版本。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 需要编译器的版本</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;{{ hi }}&lt;/div&gt;'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_3-1-2-runtime-only"><a href="#_3-1-2-runtime-only" class="header-anchor">#</a> 3.1.2 Runtime Only</h3> <p>只包含运行时的代码拥有创建<code>Vue</code>实例、渲染并处理<code>Virtual DOM</code>等功能，基本上就是除去编译器外的完整代码。<code>Runtime Only</code>的适用场景有两种：
1.我们在选项中通过手写<code>render</code>函数去定义渲染过程，这个时候并不需要包含编译器的版本便可完整执行。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 不需要编译器</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hi<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>2.借助<code>vue-loader</code>这样的编译工具进行编译，当我们利用<code>webpack</code>进行<code>Vue</code>的工程化开发时，常常会利用<code>vue-loader</code>对<code>.vue</code>进行编译，尽管我们也是利用<code>template</code>模板标签去书写代码，但是此时的<code>Vue</code>已经不需要利用编译器去负责模板的编译工作了，这个过程交给了插件去实现。</p> <p>很明显，编译过程对性能会造成一定的损耗，并且由于加入了编译的流程代码，<code>Vue</code>代码的总体积也更加庞大(运行时版本相比完整版体积要小大约 30%)。因此在实际开发中，我们需要借助像<code>webpack</code>的<code>vue-loader</code>这类工具进行编译，将<code>Vue</code>对模板的编译阶段合并到<code>webpack</code>的构建流程中，这样不仅减少了生产环境代码的体积，也大大提高了运行时的性能，一举两得。</p> <h2 id="_3-2-实例挂载的基本思路"><a href="#_3-2-实例挂载的基本思路" class="header-anchor">#</a> 3.2 实例挂载的基本思路</h2> <p>有了上面的基础，我们回头看初始化<code>_init</code>的代码，在代码中我们观察到<code>initProxy</code>后有一系列的函数调用，这些函数包括了创建组件关联，初始化事件处理，定义渲染函数，构建数据响应式系统等，最后还有一段代码,在<code>el</code>存在的情况下，实例会调用<code>$mount</code>进行实例挂载。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ···
  <span class="token comment">// 选项合并</span>
  vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
    <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
    options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    vm
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 数据代理</span>
  <span class="token function">initProxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  vm<span class="token punctuation">.</span>_self <span class="token operator">=</span> vm<span class="token punctuation">;</span>
  <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化事件处理</span>
  <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 定义渲染函数</span>
  <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 构建响应式系统</span>
  <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 等等</span>
  ···
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>以手写<code>template</code>模板为例，理清楚什么是挂载。<strong>我们会在选项中传递<code>template</code>为属性的模板字符串，如<code>&lt;div&gt;&lt;/div&gt;</code>，最终这个模板字符串通过中间过程将其转成真实的<code>DOM</code>节点，并挂载到选项中<code>el</code>代表的根节点上完成视图渲染。这个中间过程就是接下来要分析的挂载流程。</strong></p> <p><code>Vue</code>挂载的流程是比较复杂的，接下来我将通过<strong>流程图，代码分析</strong>两种方式为大家展示挂载的真实过程。</p> <h3 id="_3-2-1-流程图"><a href="#_3-2-1-流程图" class="header-anchor">#</a> 3.2.1 流程图</h3> <p><img src="/book-docs/vue-depth-analysisassets/img/3.1.67d4a9ed.png" alt="">
如果用一句话概括挂载的过程，可以描述为<strong>确认挂载节点,编译模板为<code>render</code>函数，渲染函数转换<code>Virtual DOM</code>,创建真实节点。</strong></p> <h3 id="_3-2-2-代码分析"><a href="#_3-2-2-代码分析" class="header-anchor">#</a> 3.2.2 代码分析</h3> <p>接下来我们从代码的角度去剖析挂载的流程。挂载的代码较多，下面只提取骨架相关的部分代码。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 内部真正实现挂载的方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用mountComponent方法挂载</span>
  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 缓存了原型上的 $mount 方法</span>
<span class="token keyword">var</span> mount <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount<span class="token punctuation">;</span>

<span class="token comment">// 重新定义$mount,为包含编译器和不包含编译器的版本提供不同封装，最终调用的是缓存原型上的$mount方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取挂载元素</span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 挂载元素不能为跟节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">===</span> document<span class="token punctuation">.</span>body <span class="token operator">||</span> el <span class="token operator">===</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token string">&quot;Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
  <span class="token comment">// 需要编译 or 不需要编译</span>
  <span class="token comment">// render选项不存在，代表是template模板的形式，此时需要进行模板的编译过程</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ···
    <span class="token comment">// 使用内部编译器编译模板</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 无论是template模板还是手写render函数最终调用缓存的$mount方法</span>
  <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// mountComponent方法思路</span>
<span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 定义updateComponent方法，在watch回调时调用。</span>
  <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// render函数渲染成虚拟DOM， 虚拟DOM渲染成真实的DOM</span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 实例化渲染watcher</span>
  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>我们用语言描述挂载流程的基本思路。</p> <ul><li>确定挂载的<code>DOM</code>元素,这个<code>DOM</code>需要保证不能为<code>html，body</code>这类跟节点。</li> <li>我们知道渲染有两种方式，一种是通过<code>template</code>模板字符串，另一种是手写<code>render</code>函数，前面提到<code>template</code>模板需要运行时进行编译，而后一个可以直接用<code>render</code>选项作为渲染函数。因此挂载阶段会有两条分支，<code>template</code>模板会先经过模板的解析，最终编译成<code>render</code>渲染函数参与实例挂载，而手写<code>render</code>函数可以绕过编译阶段，直接调用挂载的<code>$mount</code>方法。</li> <li>针对<code>template</code>而言，它会利用<code>Vue</code>内部的编译器进行模板的编译，字符串模板会转换为抽象的语法树，即<code>AST</code>树，并最终转化为一个类似<code>function(){with(){}}</code>的渲染函数，这是我们后面讨论的重点。</li> <li>无论是<code>template</code>模板还是手写<code>render</code>函数，最终都将进入<code>mountComponent</code>过程,这个阶段会实例化一个渲染<code>watcher</code>,具体<code>watcher</code>的内容，另外放章节讨论。我们先知道一个结论，渲染<code>watcher</code>的回调函数有两个执行时机，一个是在初始化时执行，另一个是当<code>vm</code>实例检测到数据发生变化时会再次执行回调函数。</li> <li>回调函数是执行<code>updateComponent</code>的过程，这个方法有两个阶段，一个是<code>vm._render</code>,另一个是<code>vm._update</code>。 <code>vm._render</code>会执行前面生成的<code>render</code>渲染函数，并生成一个<code>Virtual Dom tree</code>,而<code>vm._update</code>会将这个<code>Virtual Dom tree</code>转化为真实的<code>DOM</code>节点。</li></ul> <h2 id="_3-3-模板编译"><a href="#_3-3-模板编译" class="header-anchor">#</a> 3.3 模板编译</h2> <p>通过文章前半段的学习，我们对<code>Vue</code>的挂载流程有了一个初略的认识。这里有两个大的流程需要我们详细去理解，一个是<code>template</code>模板的编译，另一个是<code>updateComponent</code>的实现细节。<code>updateComponent</code>的过程，我们放到下一章节重点分析，而这一节剩余的内容我们将会围绕模板编译的设计思路展开。</p> <p>(编译器的实现细节是异常复杂的，要在短篇幅内将整个编译的过程掌握是不切实际的，并且从大方向上也不需要完全理清编译的流程。因此针对模板，文章分析只是浅尝即止，更多的细节读者可以自行分析)</p> <h2 id="_3-3-1-template的三种写法"><a href="#_3-3-1-template的三种写法" class="header-anchor">#</a> 3.3.1 template的三种写法</h2> <p><code>template</code>模板的编写有三种方式，分别是：</p> <ul><li>字符串模板</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;模板字符串&lt;/div&gt;'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>选择符匹配元素的 <code>innerHTML</code>模板</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>test1<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;x-template&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;test&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token string">'#test'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><code>dom</code>元素匹配元素的<code>innerHTML</code>模板</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>test1<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">&quot;test&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;test2&quot;</span><span class="token operator">&gt;</span>test2<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#test'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>模板编译的前提需要对<code>template</code>模板字符串的合法性进行检测，三种写法对应代码的三个不同分支。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ···
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 针对字符串模板和选择符匹配模板</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> template <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 选择符匹配模板，以'#'为前缀的选择器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 获取匹配元素的innerHTML</span>
          template <span class="token operator">=</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* istanbul ignore if */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span>
              <span class="token punctuation">(</span><span class="token string">&quot;Template element not found or is empty: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>template<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token keyword">this</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 针对dom元素匹配</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取匹配元素的innerHTML</span>
        template <span class="token operator">=</span> template<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 其他类型则判定为非法传入</span>
        <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'invalid template option:'</span> <span class="token operator">+</span> template<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果没有传入template模板，则默认以el元素所属的根节点作为基础模板</span>
      template <span class="token operator">=</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 判断el元素是否存在</span>
<span class="token keyword">function</span> <span class="token function">query</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> selected <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token string">'Cannot find element: '</span> <span class="token operator">+</span> el
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> selected
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> el
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token keyword">var</span> idToTemplate <span class="token operator">=</span> <span class="token function">cached</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> el <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> el <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>innerHTML
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p><strong>注意：其中X-Template模板的方式一般用于模板特别大的 demo 或极小型的应用，官方不建议在其他情形下使用，因为这会将模板和组件的其它定义分离开。</strong></p> <h2 id="_3-3-2-编译流程图解"><a href="#_3-3-2-编译流程图解" class="header-anchor">#</a> 3.3.2 编译流程图解</h2> <p><code>vue</code>源码中编译的设计思路是比较绕，涉及的函数处理逻辑比较多，实现流程中巧妙的运用了偏函数的技巧将配置项处理和编译核心逻辑抽取出来，为了理解这个设计思路，我画了一个逻辑图帮助理解。</p> <p><img src="/book-docs/vue-depth-analysisassets/img/3.2.ae223bee.png" alt=""></p> <h2 id="_3-3-3-逻辑解析"><a href="#_3-3-3-逻辑解析" class="header-anchor">#</a> 3.3.3 逻辑解析</h2> <p>即便有流程图，编译逻辑理解起来依然比较晦涩，接下来，结合代码分析每个环节的执行过程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ···
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> ref <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          outputSourceRange<span class="token operator">:</span> <span class="token string">&quot;development&quot;</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
          shouldDecodeNewlines<span class="token operator">:</span> shouldDecodeNewlines<span class="token punctuation">,</span>
          shouldDecodeNewlinesForHref<span class="token operator">:</span> shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
          delimiters<span class="token operator">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>
          comments<span class="token operator">:</span> options<span class="token punctuation">.</span>comments
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> render <span class="token operator">=</span> ref<span class="token punctuation">.</span>render<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>compileToFunctions</code>有三个参数，一个是<code>template</code>模板，另一个是编译的配置信息，并且这个方法是对外暴露的编译方法，用户可以自定义配置信息进行模板的编译。最后一个参数是<code>Vue</code>实例。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 将compileToFunction方法暴露给Vue作为静态方法存在</span>
Vue<span class="token punctuation">.</span>compile <span class="token operator">=</span> compileToFunctions<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在<code>Vue</code>的官方文档中，<code>Vue.compile</code>只允许传递一个<code>template</code>模板参数，这是否意味着用户无法决定某些编译的行为？显然不是的，我们看回代码，有两个选项配置可以提供给用户，用户只需要在实例化<code>Vue</code>时传递选项改变配置，他们分别是：</p> <p>1.<code>delimiters</code>： 该选项可以改变纯文本插入分隔符，当不传递值时，<code>Vue</code>默认的分隔符为 <code>{{}}</code>。如果我们想使用其他模板，可以通过<code>delimiters</code>修改。</p> <p>2.<code>comments</code> ： 当设为 <code>true</code> 时，将会保留且渲染模板中的 <code>HTML</code>注释。默认行为是舍弃它们。</p> <p><strong>注意，由于这两个选项是在完整版的编译流程读取的配置，所以在运行时版本配置这两个选项是无效的</strong></p> <p>接着我们一步步寻找<code>compileToFunctions</code>的根源。</p> <p>首先我们需要有一个认知，<strong>不同平台对<code>Vue</code>的编译过程是不一样的，也就是说基础的编译方法会随着平台的不同有区别，编译阶段的配置选项也因为平台的不同呈现差异。但是设计者又不希望在相同平台下编译不同模板时，每次都要传入相同的配置选项。这才有了源码中较为复杂的编译实现。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">baseCompile</span> <span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span>options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//把模板解析成抽象的语法树</span>
  <span class="token keyword">var</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 配置中有代码优化选项则会对Ast语法树进行优化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    ast<span class="token operator">:</span> ast<span class="token punctuation">,</span>
    render<span class="token operator">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
    staticRenderFns<span class="token operator">:</span> code<span class="token punctuation">.</span>staticRenderFns
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ref$<span class="token number">1</span> <span class="token operator">=</span> <span class="token function">createCompiler</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> compile <span class="token operator">=</span> ref$<span class="token number">1.</span>compile<span class="token punctuation">;</span>
<span class="token keyword">var</span> compileToFunctions <span class="token operator">=</span> ref$<span class="token number">1.</span>compileToFunctions<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这部分代码是在<code>Vue</code>引入阶段定义的，<code>createCompilerCreator</code>在传递了一个<code>baseCompile</code>函数作为参数后，返回了一个编译器的生成器，也就是<code>createCompiler</code>,有了这个生成器，当将编译配置选项<code>baseOptions</code>传入后,这个编译器生成器便<strong>生成了一个指定环境指定配置下的编译器</strong>，而其中编译执行函数就是返回对象的<code>compileToFunctions</code>。</p> <p>这里的<code>baseCompile</code>是真正执行编译功能的地方，也就是前面说到的特定平台的编译方法。它在源码初始化时就已经作为参数的形式保存在内存变量中。我们先看看<code>baseCompile</code>的大致流程。</p> <p><code>baseCompile</code>函数的参数有两个，一个是后续传入的<code>template</code>模板,另一个是编译需要的配置参数。函数实现的功能如下几个：</p> <ul><li>1.把模板解析成抽象的语法树，简称<code>AST</code>，代码中对应<code>parse</code>部分。</li> <li>2.可选：优化<code>AST</code>语法树，执行<code>optimize</code>方法。</li> <li>3.根据不同平台将<code>AST</code>语法树转换成渲染函数，对应的<code>generate</code>函数</li></ul> <p>接下来具体看看<code>createCompilerCreator</code>的实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCompilerCreator</span> <span class="token punctuation">(</span><span class="token parameter">baseCompile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">createCompiler</span> <span class="token punctuation">(</span><span class="token parameter">baseOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 内部定义compile方法</span>
      <span class="token keyword">function</span> <span class="token function">compile</span> <span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ···
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        compile<span class="token operator">:</span> compile<span class="token punctuation">,</span>
        compileToFunctions<span class="token operator">:</span> <span class="token function">createCompileToFunctionFn</span><span class="token punctuation">(</span>compile<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>createCompilerCreator</code>函数只有一个作用，利用<strong>偏函数</strong>的思想将<code>baseCompile</code>这一基础的编译方法缓存，并返回一个编程器生成器，当执行<code>var ref$1 = createCompiler(baseOptions);</code>时，<code>createCompiler</code>会将内部定义的<code>compile</code>和<code>compileToFunctions</code>返回。</p> <p>我们继续关注<code>compileToFunctions</code>的由来，它是<code>createCompileToFunctionFn</code>函数以<code>compile</code>为参数返回的方法，接着看<code>createCompileToFunctionFn</code>的实现逻辑。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">function</span> <span class="token function">createCompileToFunctionFn</span> <span class="token punctuation">(</span><span class="token parameter">compile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">compileToFunctions</span> <span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span>options<span class="token punctuation">,</span>vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ···
      <span class="token comment">// 缓存的作用：避免重复编译同个模板造成性能的浪费</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 执行编译方法</span>
      <span class="token keyword">var</span> compiled <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ···
      <span class="token comment">// turn code into functions</span>
      <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> fnGenErrors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 编译出的函数体字符串作为参数传递给createFunction,返回最终的render函数</span>
      res<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>render<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> compiled<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ···
      <span class="token keyword">return</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><code>createCompileToFunctionFn</code>利用了闭包的概念，将编译过的模板进行缓存,<code>cache</code>会将之前编译过的结果保留下来，利用缓存可以避免重复编译引起的浪费性能。<code>createCompileToFunctionFn</code>最终会将<code>compileToFunctions</code>方法返回。</p> <p>接下来，我们分析一下<code>compileToFunctions</code>的实现逻辑。在判断不使用缓存的编译结果后，<code>compileToFunctions</code>会执行<code>compile</code>方法，这个方法是前面分析<code>createCompiler</code>时，返回的内部<code>compile</code>方法，所以我们需要先看看<code>compile</code>的实现。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCompiler</span> <span class="token punctuation">(</span><span class="token parameter">baseOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">compile</span> <span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> finalOptions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> tips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> <span class="token function-variable function">warn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> range<span class="token punctuation">,</span> tip</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">(</span>tip <span class="token operator">?</span> tips <span class="token operator">:</span> errors<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 选项合并</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          ···
          <span class="token comment">// 这里会将用户传递的配置和系统自带编译配置进行合并</span>
        <span class="token punctuation">}</span>

        finalOptions<span class="token punctuation">.</span>warn <span class="token operator">=</span> warn<span class="token punctuation">;</span>
        <span class="token comment">// 将剔除空格后的模板以及合并选项后的配置作为参数传递给baseCompile方法</span>
        <span class="token keyword">var</span> compiled <span class="token operator">=</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> finalOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
          <span class="token function">detectErrors</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>ast<span class="token punctuation">,</span> warn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        compiled<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors<span class="token punctuation">;</span>
        compiled<span class="token punctuation">.</span>tips <span class="token operator">=</span> tips<span class="token punctuation">;</span>
        <span class="token keyword">return</span> compiled
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        compile<span class="token operator">:</span> compile<span class="token punctuation">,</span>
        compileToFunctions<span class="token operator">:</span> <span class="token function">createCompileToFunctionFn</span><span class="token punctuation">(</span>compile<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>我们看到<code>compile</code>真正执行的方法，是一开始在创建编译器生成器时，传入的基础编译方法<code>baseCompile</code>，<code>baseCompile</code>真正执行的时候，会将用户传递的编译配置和系统自带的编译配置选项合并，这也是开头提到编译器设计思想的精髓。</p> <p>执行完<code>compile</code>会返回一个对象,<code>ast</code>顾名思义是模板解析成的抽象语法树，<code>render</code>是最终生成的<code>with</code>语句,<code>staticRenderFns</code>是以数组形式存在的静态<code>render</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  ast<span class="token operator">:</span> ast<span class="token punctuation">,</span>
  render<span class="token operator">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
  staticRenderFns<span class="token operator">:</span> code<span class="token punctuation">.</span>staticRenderFns
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>而<code>createCompileToFunctionFn</code>最终会返回另外两个包装过的属性<code>render, staticRenderFns</code>，他们的核心是<strong>将 <code>with</code>语句封装成执行函数。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 编译出的函数体字符串作为参数传递给createFunction,返回最终的render函数</span>
  res<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>render<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> compiled<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">createFunction</span> <span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> errors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> err<span class="token operator">:</span> err<span class="token punctuation">,</span> code<span class="token operator">:</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> noop
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>至此，<code>Vue</code>中关于编译器的设计思路也基本梳理清楚了，一开始看代码的时候，总觉得编译逻辑的设计特别的绕，分析完代码后发现，这正是作者思路巧妙的地方。<code>Vue</code>在不同平台上有不同的编译过程，而每个编译过程的<code>baseOptions</code>选项会有所不同，同时也提供了一些选项供用户去配置，整个设计思想深刻的应用了偏函数的设计思想，而偏函数又是闭包的应用。作者利用偏函数将不同平台的编译方式进行缓存，同时剥离出编译相关的选项合并，这些方式都是值得我们日常学习的。</p> <p>编译的核心是<code>parse,generate</code>过程，这两个过程笔者并没有分析，原因是抽象语法树的解析分支较多，需要结合实际的代码场景才更好理解。这两部分的代码会在后面介绍到具体逻辑功能章节时再次提及。</p> <h2 id="_3-4-小结"><a href="#_3-4-小结" class="header-anchor">#</a> 3.4 小结</h2> <p>这一节的内容有两大块，首先详细的介绍了实例在挂载阶段的完整流程，当我们传入选项进行实例化时，最终的目的是将选项渲染成页面真实的可视节点。这个选项有两种形式，一个是以<code>template</code>模板字符串传入，另一个是手写<code>render</code>函数形式传入，不论哪种，最终会以<code>render</code>函数的形式参与挂载，<code>render</code>是一个用函数封装好的<code>with</code>语句。渲染真实节点前需要将<code>render</code>函数解析成虚拟<code>DOM</code>,虚拟<code>DOM</code>是<code>js</code>和真实<code>DOM</code>之间的桥梁。最终的<code>_update</code>过程让将虚拟<code>DOM</code>渲染成真实节点。第二个大块主要介绍了作者在编译器设计时巧妙的实现思路。过程大量运用了偏函数的概念，将编译过程进行缓存并且将选项合并从编译过程中剥离。这些设计理念、思想都是值得我们开发者学习和借鉴的。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book-docs/vue-depth-analysis/完整渲染流程.html" class="prev">
        完整渲染流程.md
      </a></span> <span class="next"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html">
        彻底搞懂Vue中keep-alive的魔法-上.md
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/book-docs/vue-depth-analysis/assets/js/app.186b0384.js" defer></script><script src="/book-docs/vue-depth-analysis/assets/js/2.d669090a.js" defer></script><script src="/book-docs/vue-depth-analysis/assets/js/11.b88ae913.js" defer></script>
  </body>
</html>
