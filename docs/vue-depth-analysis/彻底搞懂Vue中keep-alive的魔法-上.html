<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>技术文档</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="技术文档">
    
    <link rel="preload" href="/book-docs/vue-depth-analysis/assets/css/0.styles.8591e10b.css" as="style"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/app.51ae15a7.js" as="script"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/2.d669090a.js" as="script"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/12.04b8c6b2.js" as="script"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/10.efbf1bb7.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/11.a0855ea9.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/13.ff3a7173.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/14.2b998cb4.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/15.7cc6e804.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/16.69094c9a.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/17.9e8b0e3b.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/18.d302e10a.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/19.bb0ceb6c.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/20.e08a7e67.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/21.584bac77.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/22.f5a9ebe3.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/23.6412c5c7.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/3.c431a2cd.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/4.39dec256.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/5.91555d41.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/6.df985286.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/7.84a5236c.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/8.b732416c.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/9.46e95ee8.js">
    <link rel="stylesheet" href="/book-docs/vue-depth-analysis/assets/css/0.styles.8591e10b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/book-docs/vue-depth-analysis/" class="home-link router-link-active"><!----> <span class="site-name">技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/book-docs/vue-depth-analysis/vue插槽，你想了解的都在这里.html" class="sidebar-link">vue插槽，你想了解的都在这里.md</a></li><li><a href="/book-docs/vue-depth-analysis/丰富的选项合并策略.html" class="sidebar-link">丰富的选项合并策略.md</a></li><li><a href="/book-docs/vue-depth-analysis/你真的了解v-model的语法糖了吗.html" class="sidebar-link">你真的了解v-model的语法糖了吗.md</a></li><li><a href="/book-docs/vue-depth-analysis/动态组件的深入分析.html" class="sidebar-link">动态组件的深入分析.md</a></li><li><a href="/book-docs/vue-depth-analysis/基础的数据代理检测.html" class="sidebar-link">基础的数据代理检测.md</a></li><li><a href="/book-docs/vue-depth-analysis/完整渲染流程.html" class="sidebar-link">完整渲染流程.md</a></li><li><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html" class="sidebar-link">实例挂载流程和模板编译.md</a></li><li><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html" class="active sidebar-link">彻底搞懂Vue中keep-alive的魔法-上.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html#_13-1-基本用法" class="sidebar-link">13.1 基本用法</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html#_13-2-从模板编译到生成vnode" class="sidebar-link">13.2 从模板编译到生成vnode</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html#_13-3-初次渲染" class="sidebar-link">13.3 初次渲染</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html#_13-4-抽象组件" class="sidebar-link">13.4 抽象组件</a></li></ul></li><li><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-下.html" class="sidebar-link">彻底搞懂Vue中keep-alive的魔法-下.md</a></li><li><a href="/book-docs/vue-depth-analysis/揭秘Vue的事件机制.html" class="sidebar-link">揭秘Vue的事件机制.md</a></li><li><a href="/book-docs/vue-depth-analysis/来，跟我一起实现diff算法.html" class="sidebar-link">来，跟我一起实现diff算法.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-上.html" class="sidebar-link">深入响应式系统构建-上.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-下.html" class="sidebar-link">深入响应式系统构建-下.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-中.html" class="sidebar-link">深入响应式系统构建-中.md</a></li><li><a href="/book-docs/vue-depth-analysis/组件基础剖析.html" class="sidebar-link">组件基础剖析.md</a></li><li><a href="/book-docs/vue-depth-analysis/组件高级用法.html" class="sidebar-link">组件高级用法.md</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>前言：上一节最后稍微提到了<code>Vue</code>内置组件的相关内容，从这一节开始，将会对某个具体的内置组件进行分析。首先是<code>keep-alive</code>，它是我们日常开发中经常使用的组件，我们在不同组件间切换时，经常要求保持组件的状态，以避免重复渲染组件造成的性能损耗，而<code>keep-alive</code>经常和上一节介绍的动态组件结合起来使用。由于内容过多，<code>keep-alive</code>的源码分析将分为上下两部分，这一节主要围绕<code>keep-alive</code>的首次渲染展开。</p></blockquote> <h2 id="_13-1-基本用法"><a href="#_13-1-基本用法" class="header-anchor">#</a> 13.1 基本用法</h2> <p><code>keep-alive</code>的使用只需要在动态组件的最外层添加标签即可。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>changeTabs(<span class="token punctuation">'</span>child1<span class="token punctuation">'</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>child1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>changeTabs(<span class="token punctuation">'</span>child2<span class="token punctuation">'</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>child2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chooseTabs<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">var</span> child1 <span class="token operator">=</span> <span class="token punctuation">{</span>
    template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;&lt;button @click=&quot;add&quot;&gt;add&lt;/button&gt;&lt;p&gt;{{num}}&lt;/p&gt;&lt;/div&gt;'</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            num<span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>num<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> child2 <span class="token operator">=</span> <span class="token punctuation">{</span>
    template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;child2&lt;/div&gt;'</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
    components<span class="token operator">:</span> <span class="token punctuation">{</span>
        child1<span class="token punctuation">,</span>
        child2<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            chooseTabs<span class="token operator">:</span> <span class="token string">'child1'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">changeTabs</span><span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>chooseTabs <span class="token operator">=</span> tab<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>简单的结果如下，动态组件在<code>child1,child2</code>之间来回切换，当第二次切到<code>child1</code>时，<code>child1</code>保留着原来的数据状态，<code>num = 5</code>。</p> <p><img src="/book-docs/vue-depth-analysis/assets/img/13.1.26aec0ca.gif" alt=""></p> <h2 id="_13-2-从模板编译到生成vnode"><a href="#_13-2-从模板编译到生成vnode" class="header-anchor">#</a> 13.2 从模板编译到生成vnode</h2> <p>按照以往分析的经验，我们会从模板的解析开始说起，第一个疑问便是：内置组件和普通组件在编译过程有区别吗？答案是没有的，不管是内置的还是用户定义组件，本质上组件在模板编译成<code>render</code>函数的处理方式是一致的，这里的细节不展开分析，有疑惑的可以参考前几节的原理分析。最终针对<code>keep-alive</code>的<code>render</code>函数的结果如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">···_c</span><span class="token punctuation">(</span><span class="token string">'keep-alive'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>attrs<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;include&quot;</span><span class="token operator">:</span><span class="token string">&quot;child2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_c</span><span class="token punctuation">(</span>chooseTabs<span class="token punctuation">,</span><span class="token punctuation">{</span>tag<span class="token operator">:</span><span class="token string">&quot;component&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>有了<code>render</code>函数，接下来从子开始到父会执行生成<code>Vnode</code>对象的过程，<code>_c('keep-alive'···)</code>的处理，会执行<code>createElement</code>生成组件<code>Vnode</code>,其中由于<code>keep-alive</code>是组件，所以会调用<code>createComponent</code>函数去创建子组件<code>Vnode</code>,<code>createComponent</code>之前也有分析过，这个环节和创建普通组件<code>Vnode</code>不同之处在于，<code>keep-alive</code>的<code>Vnode</code>会剔除多余的属性内容，<strong>由于<code>keep-alive</code>除了<code>slot</code>属性之外，其他属性在组件内部并没有意义，例如<code>class</code>样式，<code>&lt;keep-alive clas=&quot;test&quot;&gt;&lt;/keep-alive&gt;</code>等，所以在<code>Vnode</code>层剔除掉多余的属性是有意义的。而<code>&lt;keep-alive slot=&quot;test&quot;&gt;</code>的写法在2.6以上的版本也已经被废弃。</strong>(其中<code>abstract</code>作为抽象组件的标志，以及其作用我们后面会讲到)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 创建子组件Vnode过程</span>
<span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">Ctordata<span class="token punctuation">,</span>context<span class="token punctuation">,</span>children<span class="token punctuation">,</span>tag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// abstract是内置组件(抽象组件)的标志</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>abstract<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只保留slot属性，其他标签属性都被移除，在vnode对象上不再存在</span>
        <span class="token keyword">var</span> slot <span class="token operator">=</span> data<span class="token punctuation">.</span>slot<span class="token punctuation">;</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data<span class="token punctuation">.</span>slot <span class="token operator">=</span> slot<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_13-3-初次渲染"><a href="#_13-3-初次渲染" class="header-anchor">#</a> 13.3 初次渲染</h2> <p><code>keep-alive</code>之所以特别，是因为它不会重复渲染相同的组件，只会利用初次渲染保留的缓存去更新节点。所以为了全面了解它的实现原理，我们需要从<code>keep-alive</code>的首次渲染开始说起。</p> <h3 id="_13-3-1-流程图"><a href="#_13-3-1-流程图" class="header-anchor">#</a> 13.3.1 流程图</h3> <p>为了理清楚流程，我大致画了一个流程图，流程图大致覆盖了初始渲染<code>keep-alive</code>所执行的过程，接下来会照着这个过程进行源码分析。</p> <p><img src="/book-docs/vue-depth-analysis/assets/img/13.2.a848094e.png" alt=""></p> <p>和渲染普通组件相同的是，<code>Vue</code>会拿到前面生成的<code>Vnode</code>对象执行真实节点创建的过程，也就是熟悉的<code>patch</code>过程,<code>patch</code>执行阶段会调用<code>createElm</code>创建真实<code>dom</code>，在创建节点途中，<code>keep-alive</code>的<code>vnode</code>对象会被认定是一个组件<code>Vnode</code>,因此针对组件<code>Vnode</code>又会执行<code>createComponent</code>函数，它会对<code>keep-alive</code>组件进行初始化和实例化。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createComponent</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// isReactivated用来判断组件是否缓存。</span>
        <span class="token keyword">var</span> isReactivated <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>keepAlive<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 执行组件初始化的内部钩子 init</span>
          <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* hydrating */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 其中一个作用是保留真实dom到vnode中</span>
          <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><code>keep-alive</code>组件会先调用内部钩子<code>init</code>方法进行初始化操作，我们先看看<code>init</code>过程做了什么操作。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 组件内部钩子</span>
<span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>_isDestroyed <span class="token operator">&amp;&amp;</span>
        vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// kept-alive components, treat as a patch</span>
        <span class="token keyword">var</span> mountedNode <span class="token operator">=</span> vnode<span class="token punctuation">;</span> <span class="token comment">// work around flow</span>
        componentVNodeHooks<span class="token punctuation">.</span><span class="token function">prepatch</span><span class="token punctuation">(</span>mountedNode<span class="token punctuation">,</span> mountedNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 将组件实例赋值给vnode的componentInstance属性</span>
        <span class="token keyword">var</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> <span class="token function">createComponentInstanceForVnode</span><span class="token punctuation">(</span>
          vnode<span class="token punctuation">,</span>
          activeInstance
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        child<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>hydrating <span class="token operator">?</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 后面分析</span>
    prepatch： <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>第一次执行，很明显组件<code>vnode</code>没有<code>componentInstance</code>属性，<code>vnode.data.keepAlive</code>也没有值，所以会<strong>调用<code>createComponentInstanceForVnode</code>方法进行组件实例化并将组件实例赋值给<code>vnode</code>的<code>componentInstance</code>属性，</strong> 最终执行组件实例的<code>$mount</code>方法进行实例挂载。</p> <p><code>createComponentInstanceForVnode</code>就是组件实例化的过程，而组件实例化从系列的第一篇就开始说了，无非就是一系列选项合并，初始化事件，生命周期等初始化操作。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createComponentInstanceForVnode</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
      _isComponent<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      _parentVnode<span class="token operator">:</span> vnode<span class="token punctuation">,</span>
      parent<span class="token operator">:</span> parent
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 内联模板的处理，忽略这部分代码</span>
    ···
    <span class="token comment">// 执行vue子组件实例化</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">vnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">.</span>Ctor</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_13-3-2-内置组件选项"><a href="#_13-3-2-内置组件选项" class="header-anchor">#</a> 13.3.2 内置组件选项</h3> <p>我们在使用组件的时候经常利用对象的形式定义组件选项，包括<code>data,method,computed</code>等，并在父组件或根组件中注册。<code>keep-alive</code>同样遵循这个道理，内置两字也说明了<code>keep-alive</code>是在<code>Vue</code>源码中内置好的选项配置，并且也已经注册到全局，这一部分的源码可以参考组态组件小节末尾对内置组件构造器和注册过程的介绍。这一部分我们重点关注一下<code>keep-alive</code>的具体选项。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// keepalive组件选项</span>
  <span class="token keyword">var</span> KeepAlive <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>
    <span class="token comment">// 抽象组件的标志</span>
    abstract<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// keep-alive允许使用的props</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      include<span class="token operator">:</span> patternTypes<span class="token punctuation">,</span>
      exclude<span class="token operator">:</span> patternTypes<span class="token punctuation">,</span>
      max<span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> Number<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">created</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">created</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 缓存组件vnode</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 缓存组件名</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">destroyed</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">mounted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> <span class="token keyword">this</span>$<span class="token number">1</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token comment">// 动态include和exclude</span>
      <span class="token comment">// 对include exclue的监听</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'include'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pruneCache</span><span class="token punctuation">(</span><span class="token keyword">this</span>$<span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">matches</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'exclude'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pruneCache</span><span class="token punctuation">(</span><span class="token keyword">this</span>$<span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// keep-alive的渲染函数</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到keep-alive下插槽的值</span>
      <span class="token keyword">var</span> slot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
      <span class="token comment">// 第一个vnode节点</span>
      <span class="token keyword">var</span> vnode <span class="token operator">=</span> <span class="token function">getFirstComponentChild</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 拿到第一个组件实例</span>
      <span class="token keyword">var</span> componentOptions <span class="token operator">=</span> vnode <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">;</span>
      <span class="token comment">// keep-alive的第一个子组件实例存在</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// check pattern</span>
        <span class="token comment">//拿到第一个vnode节点的name</span>
        <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> include <span class="token operator">=</span> ref<span class="token punctuation">.</span>include<span class="token punctuation">;</span>
        <span class="token keyword">var</span> exclude <span class="token operator">=</span> ref<span class="token punctuation">.</span>exclude<span class="token punctuation">;</span>
        <span class="token comment">// 通过判断子组件是否满足缓存匹配</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token comment">// not included</span>
          <span class="token punctuation">(</span>include <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>include<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token comment">// excluded</span>
          <span class="token punctuation">(</span>exclude <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>exclude<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> vnode
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> ref$<span class="token number">1</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> cache <span class="token operator">=</span> ref$<span class="token number">1.</span>cache<span class="token punctuation">;</span>
        <span class="token keyword">var</span> keys <span class="token operator">=</span> ref$<span class="token number">1.</span>keys<span class="token punctuation">;</span>
        <span class="token keyword">var</span> key <span class="token operator">=</span> vnode<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token keyword">null</span>
          <span class="token operator">?</span> componentOptions<span class="token punctuation">.</span>Ctor<span class="token punctuation">.</span>cid <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span>tag <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">&quot;::&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> vnode<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
          <span class="token comment">// 再次命中缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
          <span class="token comment">// make current key freshest</span>
          <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
          keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初次渲染时，将vnode缓存</span>
          cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>
          keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// prune oldest entry</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 为缓存组件打上标志</span>
        vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 将渲染的vnode返回</span>
      <span class="token keyword">return</span> vnode <span class="token operator">||</span> <span class="token punctuation">(</span>slot <span class="token operator">&amp;&amp;</span> slot<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><p><code>keep-alive</code>选项跟我们平时写的组件选项还是基本类似的，唯一的不同是<code>keep-ailve</code>组件没有用<code>template</code>而是使用<code>render</code>函数。<code>keep-alive</code>本质上只是存缓存和拿缓存的过程，并没有实际的节点渲染，所以使用<code>render</code>处理是最优的选择。</p> <h3 id="_13-3-3-缓存vnode"><a href="#_13-3-3-缓存vnode" class="header-anchor">#</a> 13.3.3 缓存vnode</h3> <p>还是先回到流程图的分析。上面说到<code>keep-alive</code>在执行组件实例化之后会进行组件的挂载。而挂载<code>$mount</code>又回到<code>vm._render(),vm._update()</code>的过程。由于<code>keep-alive</code>拥有<code>render</code>函数，所以我们可以直接将焦点放在<code>render</code>函数的实现上。</p> <ul><li>首先是获取<code>keep-alive</code>下插槽的内容，也就是<code>keep-alive</code>需要渲染的子组件,例子中是<code>chil1 Vnode</code>对象，源码中对应<code>getFirstComponentChild</code>函数。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">getFirstComponentChild</span> <span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> c <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 组件实例存在，则返回，理论上返回第一个组件vnode</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>componentOptions<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isAsyncPlaceholder</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> c
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>判断组件满足缓存的匹配条件，在<code>keep-alive</code>组件的使用过程中，<code>Vue</code>源码允许我们是用<code>include, exclude</code>来定义匹配条件，<code>include</code>规定了只有名称匹配的组件才会被缓存，<code>exclude</code>规定了任何名称匹配的组件都不会被缓存。更者，我们可以使用<code>max</code>来限制可以缓存多少匹配实例，而为什么要做数量的限制呢？我们后文会提到。</li></ul> <p>拿到子组件的实例后，我们需要先进行是否满足匹配条件的判断,<strong>其中匹配的规则允许使用数组，字符串，正则的形式。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> include <span class="token operator">=</span> ref<span class="token punctuation">.</span>include<span class="token punctuation">;</span>
<span class="token keyword">var</span> exclude <span class="token operator">=</span> ref<span class="token punctuation">.</span>exclude<span class="token punctuation">;</span>
<span class="token comment">// 通过判断子组件是否满足缓存匹配</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token comment">// not included</span>
    <span class="token punctuation">(</span>include <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>include<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token comment">// excluded</span>
    <span class="token punctuation">(</span>exclude <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>exclude<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>

<span class="token comment">// matches</span>
<span class="token keyword">function</span> <span class="token function">matches</span> <span class="token punctuation">(</span><span class="token parameter">pattern<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 允许使用数组['child1', 'child2']</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pattern<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> pattern <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 允许使用字符串 child1,child2</span>
        <span class="token keyword">return</span> pattern<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRegExp</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 允许使用正则 /^child{1,2}$/g</span>
        <span class="token keyword">return</span> pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* istanbul ignore next */</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>如果组件不满足缓存的要求，则直接返回组件的<code>vnode</code>,不做任何处理,此时组件会进入正常的挂载环节。</p> <ol start="3"><li><code>render</code>函数执行的关键一步是缓存<code>vnode</code>,由于是第一次执行<code>render</code>函数，选项中的<code>cache</code>和<code>keys</code>数据都没有值，其中<code>cache</code>是一个空对象，我们将用它来缓存<code>{ name: vnode }</code>枚举，而<code>keys</code>我们用来缓存组件名。
<strong>因此我们在第一次渲染<code>keep-alive</code>时，会将需要渲染的子组件<code>vnode</code>进行缓存。</strong></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>    cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>
    keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="4"><li>将已经缓存的<code>vnode</code>打上标记, 并将子组件的<code>Vnode</code>返回。
<code>vnode.data.keepAlive = true</code></li></ol> <h3 id="_13-3-4-真实节点的保存"><a href="#_13-3-4-真实节点的保存" class="header-anchor">#</a> 13.3.4 真实节点的保存</h3> <p>我们再回到<code>createComponent</code>的逻辑，之前提到<code>createComponent</code>会先执行<code>keep-alive</code>组件的初始化流程，也包括了子组件的挂载。并且我们通过<code>componentInstance</code>拿到了<code>keep-alive</code>组件的实例，而接下来<strong>重要的一步是将真实的<code>dom</code>保存再<code>vnode</code>中</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> insertedVnodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ···
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 其中一个作用是保留真实dom到vnode中</span>
        <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将真实节点添加到父节点中</span>
        <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>insert</code>的源码不列举出来，它只是简单的调用操作<code>dom</code>的<code>api</code>,将子节点插入到父节点中，我们可以重点看看<code>initComponent</code>关键步骤的逻辑。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ···
    <span class="token comment">// vnode保留真实节点</span>
    vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>$el<span class="token punctuation">;</span>
    ···
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>因此，我们很清晰的回到之前遗留下来的问题，为什么<code>keep-alive</code>需要一个<code>max</code>来限制缓存组件的数量。原因就是<code>keep-alive</code>缓存的组件数据除了包括<code>vnode</code>这一描述对象外，还保留着真实的<code>dom</code>节点,而我们知道真实节点对象是庞大的，所以大量保留缓存组件是耗费性能的。因此我们需要严格控制缓存的组件数量，而在缓存策略上也需要做优化，这点我们在下一篇文章也继续提到。</strong></p> <p>由于<code>isReactivated</code>为<code>false</code>,<code>reactivateComponent</code>函数也不会执行。至此<code>keep-alive</code>的初次渲染流程分析完毕。</p> <p><strong>如果忽略步骤的分析，只对初次渲染流程做一个总结：内置的<code>keep-alive</code>组件，让子组件在第一次渲染的时候将<code>vnode</code>和真实的<code>elm</code>进行了缓存。</strong></p> <h2 id="_13-4-抽象组件"><a href="#_13-4-抽象组件" class="header-anchor">#</a> 13.4 抽象组件</h2> <p>这一节的最后顺便提一下上文提到的抽象组件的概念。<code>Vue</code>提供的内置组件都有一个描述组件类型的选项，这个选项就是<code>{ astract: true }</code>,它表明了该组件是抽象组件。什么是抽象组件，为什么要有这一类型的区别呢？我觉得归根究底有两个方面的原因。</p> <ol><li>抽象组件没有真实的节点，它在组件渲染阶段不会去解析渲染成真实的<code>dom</code>节点，而只是作为中间的数据过渡层处理，在<code>keep-alive</code>中是对组件缓存的处理。</li> <li>在我们介绍组件初始化的时候曾经说到父子组件会显式的建立一层关系，这层关系奠定了父子组件之间通信的基础。我们可以再次回顾一下<code>initLifecycle</code>的代码。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ···
    <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initLifecycle</span> <span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
    
    <span class="token keyword">var</span> parent <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>abstract<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有abstract属性，一直往上层寻找，直到不是抽象组件</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>abstract <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>$parent<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      parent<span class="token punctuation">.</span>$children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ···
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>子组件在注册阶段会把父实例挂载到自身选项的<code>parent</code>属性上，在<code>initLifecycle</code>过程中，会反向拿到<code>parent</code>上的父组件<code>vnode</code>,并为其<code>$children</code>属性添加该子组件<code>vnode</code>,如果在反向找父组件的过程中，父组件拥有<code>abstract</code>属性，即可判定该组件为抽象组件，此时利用<code>parent</code>的链条往上寻找，直到组件不是抽象组件为止。<code>initLifecycle</code>的处理，让每个组件都能找到上层的父组件以及下层的子组件，使得组件之间形成一个紧密的关系树。</p> <h3 id="_13-5-小结"><a href="#_13-5-小结" class="header-anchor">#</a> 13.5 小结</h3> <p>这一节介绍了<code>Vue</code>内置组件中一个最重要的，也是最常用的组件<code>keep-alive</code>，在日常开发中，我们经常将<code>keep-alive</code>配合动态组件<code>is</code>使用，达到切换组件的同时，将旧的组件缓存。最终达到保留初始状态的目的。在第一次组件渲染时，<code>keep-alive</code>会将组件<code>Vnode</code>以及对应的真实节点进行缓存。而当再次渲染组件时，<code>keep-alive</code>是如何利用这些缓存的？源码又对缓存进行了优化？并且<code>keep-alive</code>组件的生命周期又包括哪些，这些疑问我们将在下一节一一展开。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html" class="prev">
        实例挂载流程和模板编译.md
      </a></span> <span class="next"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-下.html">
        彻底搞懂Vue中keep-alive的魔法-下.md
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/book-docs/vue-depth-analysis/assets/js/app.51ae15a7.js" defer></script><script src="/book-docs/vue-depth-analysis/assets/js/2.d669090a.js" defer></script><script src="/book-docs/vue-depth-analysis/assets/js/12.04b8c6b2.js" defer></script>
  </body>
</html>
