<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>技术文档</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="技术文档">
    
    <link rel="preload" href="/book-docs/vue-depth-analysis/assets/css/0.styles.aa1e90bd.css" as="style"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/app.186b0384.js" as="script"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/2.d669090a.js" as="script"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/13.ce31926b.js" as="script"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/10.7852d010.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/11.b88ae913.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/12.8d172228.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/14.967cef5e.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/15.635a9e78.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/16.746833fb.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/17.b5030f17.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/18.b41eb005.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/19.bb0ceb6c.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/20.e08a7e67.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/21.ceb288f7.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/22.f5a9ebe3.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/23.d95b6104.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/3.c431a2cd.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/4.b2e60800.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/5.17163f3d.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/6.bfaa3de2.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/7.1e431d66.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/8.b732416c.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/9.712a636c.js">
    <link rel="stylesheet" href="/book-docs/vue-depth-analysis/assets/css/0.styles.aa1e90bd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/book-docs/vue-depth-analysis/" class="home-link router-link-active"><!----> <span class="site-name">技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/book-docs/vue-depth-analysis/vue插槽，你想了解的都在这里.html" class="sidebar-link">vue插槽，你想了解的都在这里.md</a></li><li><a href="/book-docs/vue-depth-analysis/丰富的选项合并策略.html" class="sidebar-link">丰富的选项合并策略.md</a></li><li><a href="/book-docs/vue-depth-analysis/你真的了解v-model的语法糖了吗.html" class="sidebar-link">你真的了解v-model的语法糖了吗.md</a></li><li><a href="/book-docs/vue-depth-analysis/动态组件的深入分析.html" class="sidebar-link">动态组件的深入分析.md</a></li><li><a href="/book-docs/vue-depth-analysis/基础的数据代理检测.html" class="sidebar-link">基础的数据代理检测.md</a></li><li><a href="/book-docs/vue-depth-analysis/完整渲染流程.html" class="sidebar-link">完整渲染流程.md</a></li><li><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html" class="sidebar-link">实例挂载流程和模板编译.md</a></li><li><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html" class="sidebar-link">彻底搞懂Vue中keep-alive的魔法-上.md</a></li><li><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-下.html" class="active sidebar-link">彻底搞懂Vue中keep-alive的魔法-下.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-下.html#_13-5-准备工作" class="sidebar-link">13.5 准备工作</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-下.html#_13-6-流程分析" class="sidebar-link">13.6 流程分析</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-下.html#_13-7-生命周期" class="sidebar-link">13.7 生命周期</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-下.html#_13-8-缓存优化-lru" class="sidebar-link">13.8 缓存优化 - LRU</a></li></ul></li><li><a href="/book-docs/vue-depth-analysis/揭秘Vue的事件机制.html" class="sidebar-link">揭秘Vue的事件机制.md</a></li><li><a href="/book-docs/vue-depth-analysis/来，跟我一起实现diff算法.html" class="sidebar-link">来，跟我一起实现diff算法.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-上.html" class="sidebar-link">深入响应式系统构建-上.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-下.html" class="sidebar-link">深入响应式系统构建-下.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-中.html" class="sidebar-link">深入响应式系统构建-中.md</a></li><li><a href="/book-docs/vue-depth-analysis/组件基础剖析.html" class="sidebar-link">组件基础剖析.md</a></li><li><a href="/book-docs/vue-depth-analysis/组件高级用法.html" class="sidebar-link">组件高级用法.md</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>上一节，我们对<code>keep-alive</code>组件的初始渲染流程以及组件的配置信息进行了源码分析。初始渲染流程最关键的一步是对渲染的组件<code>Vnode</code>进行缓存，其中也包括了组件的真实节点存储。有了第一次的缓存，当再次渲染组件时，<code>keep-alive</code>又拥有哪些魔法呢？接下来我们将彻底揭开这一层面纱。</p></blockquote> <h2 id="_13-5-准备工作"><a href="#_13-5-准备工作" class="header-anchor">#</a> 13.5 准备工作</h2> <p>上一节对<code>keep-alive</code>组件的分析，是从我画的一个流程图开始的。如果不想回过头看上一节的内容，可以参考以下的简单总结。</p> <ol><li><code>keep-alive</code>是源码内部定义的组件选项配置，它会先注册为全局组件供开发者全局使用，其中<code>render</code>函数定义了它的渲染过程</li> <li>和普通组件一致，当父在创建真实节点的过程中，遇到<code>keep-alive</code>的组件会进行组件的初始化和实例化。</li> <li>实例化会执行挂载<code>$mount</code>的过程，这一步会执行<code>keep-alive</code>选项中的<code>render</code>函数。</li> <li><code>render</code>函数在初始渲染时，会将渲染的子<code>Vnode</code>进行缓存。同时<strong>对应的子真实节点也会被缓存起来</strong>。</li></ol> <p>那么，当再次需要渲染到已经被渲染过的组件时，<code>keep-alive</code>的处理又有什么不同呢？</p> <h3 id="_13-5-1-基础使用"><a href="#_13-5-1-基础使用" class="header-anchor">#</a> 13.5.1 基础使用</h3> <p>为了文章的完整性，我依旧把基础的使用展示出来，其中加入了生命周期的使用，方便后续对<code>keep-alive</code>生命周期的分析。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>changeTabs(<span class="token punctuation">'</span>child1<span class="token punctuation">'</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>child1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>changeTabs(<span class="token punctuation">'</span>child2<span class="token punctuation">'</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>child2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>keep-alive</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chooseTabs<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>keep-alive</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> child1 <span class="token operator">=</span> <span class="token punctuation">{</span>
    template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;&lt;button @click=&quot;add&quot;&gt;add&lt;/button&gt;&lt;p&gt;{{num}}&lt;/p&gt;&lt;/div&gt;'</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            num<span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>num<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child1 mounted'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">activated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child1 activated'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">deactivated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child1 deactivated'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">destoryed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child1 destoryed'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> child2 <span class="token operator">=</span> <span class="token punctuation">{</span>
    template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;child2&lt;/div&gt;'</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child2 mounted'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">activated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child2 activated'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">deactivated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child2 deactivated'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">destoryed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child2 destoryed'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
    components<span class="token operator">:</span> <span class="token punctuation">{</span>
        child1<span class="token punctuation">,</span>
        child2<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            chooseTabs<span class="token operator">:</span> <span class="token string">'child1'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">changeTabs</span><span class="token punctuation">(</span><span class="token parameter">tab</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>chooseTabs <span class="token operator">=</span> tab<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="_13-5-2-流程图"><a href="#_13-5-2-流程图" class="header-anchor">#</a> 13.5.2 流程图</h3> <p>和首次渲染的分析一致，再次渲染的过程我依旧画了一个简单的流程图。</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAtsAAAD4CAAAAAAYvHXFAAAc+UlEQVR42u2dj48kR3XH7x9CJ7USKSIokEB8WAMCJ/w4sLZDLpwWJ94Ap6yitBGWBzQo4TBQIcbn3GBCVuwlglAOkXBuEmQfA1hcWXY4X1hDaB9Z1me0I3c0CddECuq896r61/zsmZ0fO7Pfkm53Z6a/069fffrVq1c1c6cSat2k1EY/PJjkYGihXZr2FPwGLdiG36AF29BCexzY7k7aDrrTN2ihXZwWcRta5CTwG7RgG1powTa00IJtaKEF29BCC7ahBdvwG7RgG1powTa00IJtaKEF29BCC7ahBdvwG7QrzDb2T0KLPa6ICdAiJ4EWWrANLbRgG1powTa00IJtaME2/AYt2IYWWrANLbRgG1powTa00IJtaME2/AYt2IYW2uPG9gG17kGpjX54MMnB0EK7NC3iNrTISeA3aMH2pNrz3iLaxi1wArYXbYO3mHZ9oFXnveW2B6v46tgaCbbHsp3Mv50fwvaSqfHOV/HVsTUSbB9vtpMlNlOV7WNqJNgG22AbbINtsA22wTbYBttgG2yDbbC9tmzHKjIqboTXlDxshpFvS0DaabTO3ifaCqe14aAzgu04sCdPwpqnEjImMToxtZBfyWtSQZwkyh2o6AEfZ62TZ0xSeNTD9lMV2NYmMWqZ2Dzz83FsRyqWiwbbFeN22Gg3yGFXTMq2ivlVrQVyY53p3kerqdn27tu9PTxuG7+V4ksGxQJpHKSkGu1uAT7GNzUyyx3HBnOny/2o6dbw/GgA219+3Uf+5dXRbBs698tKDDhKUz13VxJufL1k0gi2vQtPvDjKyDgwSWxq5gjmhVvRELsfDvTasc08eF7t5jZj8xTzVYzb2tjXzz5fywOoH03DNrU/+NJ/Ds1J8pjJXDfDrD8LYTts8quWafprN3vNSNzm21CrQXH7y3TMr/3pN34+nG1jATwy3L1s99s0gm1qW185HGaku9fDo8BdYDvcCEvezwblFWe79M2XN+6+SD8e6R4+dKPbfeTG/sXD7o2HDq9c4deuXLt4jX5eke/MpFf2t/en+77NHzoK7/389+2zxZ5jN1u2Fd1SqrA2ZocNjttCtNZ0mGPb9oW2MCqHeMp9xvbTcrLH3dtt/d1P+05u75M0tio/minbfFlREPWwfW6Qn77pjHz/4z8aZGTk6zQa6VmzXU7vRhm5Wt/jajxFkXj3oZgy7zQnCRsueujdmuKYSPdI2KRXosAwPVPGbdvec2mvNypFvjGKEwuVvCx+byYD4raxf+zKEGIkHw9rxCKhr4wyuh1kec2AuJ3i/ZVOf0ikLt+N7G+GM4/eEivphwl2bc5j0Y+Dlu9HbLDmRE3bUY5+BQ3NHvXINnuMTAOUqRy3bTv3pZ/0Gal02HK/CdBC9JYhx/iv0PnIPJXOlHhqQn6lZKttMzU2d5ek1mwjrmL3Khc4ynFhHXIS8oxRYU09Esq1Ka/lcpJayMFQ7TZ4/nLA+aiwHbFny2eZfKvCOz/3Qn9OEgW3G6GNcTpLQ8pxO/2LQky0dT/zQ0yHG23HNh9b6qHB240+sDtgmuabfD5RyEx4XGAXCQ3MgrJs+5EEUpZpz058OfYb9zdJ5Bg7W+lJSgibCjsYm/2DC5vlUocC22wD3X58PkLV2El4gW2Gl66IzRWb6C7mQzhu8+Xw7SuDZjkpWY8aoJGevGIIGE1EMxw2blPSqzkpoGcO8kjK9MyJ7YjPL/WAZuTG92y0pLPaGaNvmvxEaBphHFAwb/DYKjkJsZ1n4xOyLeD0pJzpyE2UGGHZpJhKOBfUyEb+TTcZz/T4sbxG72R/y61qZsN2wYByRFdsZmaTu4qMbY7Z9Lp0s8tJ+BBJBPk1ekdJR8olmLWI2+JJldwIglB4DoMtl7zaCR0NuZreJ0wnkyqZQ04SREbzDxswtQy/0g+luaSN28b2Rdy4GTRpJJGeVLs1idt9bFfLSWwdMg70oASaz8CGWbTEDOFYO3cwbfSEM0Q7iy3rw9ieIidhYS00A+YD5CitnE2pncWcxEZ7uSnYp8pNTZht59k1ZVu6hhLCri0dNyke8jV2tbBNjMk4dpDW3OwMZHq2/S98f0AVgN5aGeLAxj4GgkuQJp2ckS22MqhMk4K7diVCz/DcwPXLhhdEjZAylFFsf/iJ/xpa36ZRYVB5m9JVTksGse0yl5RtfllyA51V7IbmJKPY3vzyy8OMdONa323Z5urgKLYZf/7N6ZUbgrK4nd5865eTxDftTOiadVszVO2cbck2+SY/cOOzy0RnXQPUHBwp31ZSvbXLMJ5JKxfGTe6plwzFZRW6uB3yYobtSkXYE0GuW6eoAcq9kqbZxUpgtLWhkxLbFD2FI0l5m2HKtqg49+a8m1dZgmwaOcFcckQN0A6yJi2WFN5Tb5CHimxzHs1msBN5CsCPWRH5lm3t4rbUXrRZ17kkXXdt1zP67lDmIM3W1u1sUPV4ssSzEHWQuBmevdFnvXbTDAVMO8ORgcSjskm6BunlAZVykmxph9gOGzc3Quo0Gl6YH+oqNeXaTVjj2aALi6Uqt7zjILYlTTNZ3Jb0SckwI26yx0gNsCeNn3bthpySjS4ltqUq2Ms2m9OUuL1rHcjlm5bNSZoSD7wgdqUeO6tR67Z2YyQSqOCQB66nPL+pYxe3JTWwna3PPuVWc9gZU63djFpzlwpJmpWGjdu+jU7Gq33L4mNs4YZgsrOAlG0joVbyJGJbuVnT5GvuKg3Zke8dZdlvwGgwwdrNyDV3uXaXmEy0wGSqHL1GazfHwIaTsleq+pp7r69mZGQlttdzzR1sL7wdR7YnMRJsg+3jwfbsjQTbYBtsg22wDbbB9glj+/wy21rscV3OXkTeyTf3lu5x7T/5o8tsw7ePFn313iV/9879q7/HdWlxe4nfmbYS3yt16/r1p6+X2uiHT05ycAXtq8hJptQ+6Ia+c+WRsOehP/LV8dpPHA606quPPqrKobTn4SdHvnpkbXsBflbeo8vs35PMNrRgG2xDC7bBNrRgG2yDbbANTsA22IYWbINtaME22IYWbINtaME22AbbYBucgG2wDS3YPkZsH4O9iNDOWUvf+HASfYW4jbiNnAScgG2wDS3YXl22b83wMx3Qzl0Ltid4nw0PbaUa2K78PoXPXU/82a6jfC4M2im13wDb1dlG3gst2IbPoQXb0EILtqGFFmxDC7bBNrRgG2xDC7bhc2iXyvYBte5BqY1+yM3zKh48QFv5YGihPZIWcRta5CRgG1qwDZ9DC7ahhRZsr5/2/OL+VwawvdZsn1/Ktumzt4ZbtRgLwPb6s72kzwRcH8V2MvcGtk8G28ni23mwvW5sL378/yrYBtsLYXsZHwcE22B7MWwvFqFHwTbYBttgG2yDbbANtsE22D6ubE/1nZmeN+qIxbOtxtq8JLafXq6XRvcTvscVcRtx++TmJP/QGcW2ySp1eoFs35of22Ejpq+PNBWubjZsN8OVYfuZomuS+GKkxDVBvLJsf9z7wyuvjIvbceBHo7ohDqxLlLKPBt8I0VZYje0P3PvYD2fLdmqg9F0URBWursT2+z5lpmE78u1tY7zaSMbDja/3m1Bm++XdzeH9m3l2PGN8qO2m0Wyra+O5yju02nkXzzbvONvZH8V25KuBHWd60THSQ+FGeES2yaR3PXLzqGwPMFBg0zZWm5FX18O25735E9+dlG26yZvhblQ0ZPBxjTDRagTbP/nSuZFbp2bAdhzQGXZr7BgllnfnxvZ+2R1zZpva+x4Ph7Ed1kxldPi3dsPYkdimds9nn5812xyWwq0o/XPE1fWxTe1N9WsTsU03ueQkw272LPNT/YNJzvZ/XN4Yty1wQraH5yR8l7E15JyLZiXZLn7z8wfzxe+3P/C1Qb3G12v5aAd2iFWchYV0j1OYpl9+ZF8yNinhlCTaMj6/KoGSf3NYaPLlafu4CtvU3kIeHsi2CdpedgJNb9/y/VcGGmj4b2dgrDgwGfZzSnt6dVXYpvb6j/7r//WzLfDSDxPskgHiEntzaWbbSNbqPCGWRmyhllc4WZHbTJlBbP/g8++qsOWVL8jQG0Zn7fVbJ5ugVXS2fdLGbUkbD+mHs8Cy/USYsk2mXdTpXCTaatWCw9TR5EhSdMsdeiDHxKk3bkiAEwiYisP0WNsvd4shGQizZXt4e+dfFXtNxqm0BVFA18RRzhjuNRsWDdketWN+SdG1cVLCHR35DLyS4xJt/04UHaT5qopxndgevd3kjR/57iC2eeRUTIwYIilzPMhAzc/dzAyUuaTWfG3fLl1d3M/2kPYrm0/+osciQYXua+bLyK2knJW1NG7nnhBL6XztyNCr5DF7e/UlJZ73ffXaYbu6+9jm94r8L8pFOycb76L4yBHXIsZUmpNwH1zzUwvkGj7sabObsh1u7Wd3fuTTwfupo60jD8sdGsoxSQ/bfBPTGeJtd6zrF4nbOQizZPvB0jc/nym67Tc//dyouK2z6WKiHDpKZy/xWM/RkDvJch/EYj09KXkAuVWed0lBRba9D3xtENvcIcSMnEBpMWCQgS48ZwYy25G6reLsqobH7aHtTfVei6QnjVhl76gUVMX3ILOdeiKzxBnFTpF0xPSzfdfwTyz0st3izIoY4wtPnWz8/XI+1NUZ2/z0RZVaIG/x9434ZcU0Kr4p/SLb9H5XCo6m975R7tAfFKcUOdtGLjK8L8pzEmXZLoAwv//v5uOFmP29ZHROYmx4MXbCUUIntVQr+VuuhNlWtg8Ne0Zcwdpi0WB0TvKr21//7yE5iX1DO3Dakw4y0LnUGfgTPr2iPCFsVWB7UE5C48iFv+n3EgdOHrbon2U7jWJNQ4FK2HaeEEvE+nRYNEPZTr73J2+q9DEccquyWQdfX+pkExxmTrcpGqdGbi5Jt8B9YWpBlm+HNYrlipxiggLb7MMrBUdTT18rd+gzxblUnpOEArPZjtO0SfrFsp2BMHe23/vYi8PqJGW2XVhQKdu6zHa4ZbaiAtsuWqVhtr9iMILtXw/++RfD5pJCB53RQVRgu2ygO2FmIMVt8XDt5lRsv/VTZvBcUmkewQawHbogmcdtk9aT0lrp0JyEfz7352+vkm8bSXmCsDiHFrbTQZJP1tU52zRh2Y5L1VpmW+mw0VbkpKiP7YKjme1yhx4MZZs7/97CsUrlcXv2c8l+tn/vC+GI+nbOtk2f2KywplzewWleO2c7Du5XSc62zTLt7zznbVZg+w0f/eYvR9QAjcxrlK1yNEPH9gADOa/jfDtn263hbE3M9u+ofxtaAzQbG2GZbZ4MqJjitink25yKi6XkpHbEttExo+aS3CkvfO6d4+eSYY3Gh9qTslrknGy8K0ma+Qvb+37OdrS1ccV6hy1wbNs5MdGd9LF9o+BocuR+uUNLbEf+FcnRJQenM0T32mPTfpF8Owdhjmy//2/3R6+552y3fBlFuPLQUDwE2jIET5Cy7EnLCJeyndjxkCttntfKpsrj2P7tj31rzNqNVCRk0lPjMdURM8hAbeskGdttG6qyeFaR7bOf+fdRaze2SN7DtgzCxuW8zhN2cIltQcfVCqQG2FcgLcK8d+k94+okTE34ZptgWCeb4IvWR67W6d3bzNlOlGTUhbLVM41IwngUNHXKtqRLYlq34GjyXbfcoZbt1KfMhJyqZStGN9yxrl+60i8ZCPNj+5Vk1Jq7mK561vbmvub+3fFr7mZADb2KgVJfEeZ0+epGs/3XP5rnmvvYtRtuP/7CpP0rOUlVNuhu084GnlAK28U4VOW82TX0VN2Py/+dOrzXFsd2Mj+2q7dF7pWqsOY+Rf9OxPYs9oRkadUs2J7DXsTFsz3VHtdFsL3qe1yvbR8udZ/q/n03Fr3Hddq4PZ+GPa7D2U7m0L+rogXbYBtsT8K2WWgD22B7cWzj+0nA9nqy/eDC/3/zb4BtsL0Qto+jFmyD7fVlG9/jCrbX89qP4/dvn597A9v4vw+Wod1YxM31FrANPhevvcUfxyu2nodPjny1ovYAbIPPVdAWM3T4CmyDbbANxsA22IbfwPaKsH2Cv+dz1bTVd6zCV/Pa4wot4jZyEmjBNtiGFmyDbbANX4FtsA224TewDbahBdtgG1qwDbahBdtgG2zDV2B7Vdm+Dl+B7TVl+1H4CmyvnfbCH1+4cI93z4ULFz4GX4HttdI+ln0Esg1fVWX7gFr3oNRGPzyY5GBoZ6Rtp2j/BnxVVYu4vSLa33VsfxS+Qk6yZtpPO7a/CV+B7TXTfs+i/dpfwldge9209wjbfwZfge21035G2P5n+Apsr532eflPjv8XvgLb66d9C7G9DV+B7TXUfpLY/if4CmyvofY6sf0/8BXYXkft67y3w1dgey21H/I+A1+B7bXUfsd7Fb4C2+up/SP46gSwfd47xu18hetd3AU8iO9xXa3v6vSOdatwvYsz5hy+x3W17s2l/HeRFVvBtuHXu6gLMDyKICc5GWzHgWfANtheHbaNkl+R7wUxP5SfWdM5zaYWJkoOVnbINpm4Iit+lP1dPsus2Ka7L21BbArZhYm2Qnnd5KdvhmB7zdluhkIEcxfWijiU2c5IsXRrvh2CaAzb4VZKM701nYFuIGpauLJ/57jPLG6TWcVb02h58ravClfGhoHtdWc7bPK/uEExmTEOG+WA6tgOaxnEmtigo4jqSdi2yEWK3l3rJGwlqsUIFjmcAdulUF0K4vkARdepVXqoBttrzPZuFG6EzdAoLf2smr7nel2XYnjknqfEJJEBXpmp2Y4VCaN5sK2yuK0M3682btOtyPeozgYezknIiESD7TVmm5FtuwBH+UGaB2vfdbzEbf4hWFLGSsC4mOe/xGzTnUEMb4RaaRsGtQuH/M67xDaHT+W4alm2JUGZT05CiUcraAnAJbZv+qVpMIHNIxSZ0ojB9trm24xw2sORb+OwYuRKbOepeDYLjENmOw7oMMXwapltakmrtfyLAz+KA5XIMcbPc5KkFSbziNvDJ5Z86kLc9tohjz3EdhNxe23Z5rw5SzfU/SqvYpTjdqGkYpPWdC6pgziioKh5mA9MJPGR3kDeg3ISI7cJ802EpWybps9Rf9ZsF2h296DSfXMHMplsk+GGByANtteVbcbBj1zeGTZNI8PDlPLtlH/JImzFoWaEbUq+mWOenzHbUmsjoPmxsJ1W5JpBM7jt8u0gq5nMoU5iCyO9oHPOXSj09N1WYHsNc5IMA54l2shs6agYtyk2cnRM2U7jNsdxZtxYesMtitNNk+YkKVvj4vZPJ2Q7vx9VNpXV6SiUxe3CXeup6mz/FGyvWr7tKRM0jB2+i2yXa4A9lW9lMtrNBo/vjm2Xb3OCzsGep4wMvjGmWAMkbjjqj2H7pcd/35uUbSMQa3shT2zRdDawEwSqZpfitm4GgZkgbltjjtRHdkwD24vLSbSU9JRnkhFs98ftfF3STkBTtoUgY3PZWmvL5h46rQHatRtRjInb337sXj72SGy7yqXqr9vTzJdOrWphNbZ/mBoDtlcsJ1H325UO6mkjk77CtpEC2yqdeNmqnn2m+gaTUtzOs4cSXqltNx95l3t5OrapSK+lUikJkaF0W6t8xhA8zBfC9tCVjM9JisacGLZXdY9rcmyb7HH9ziffNmDP6+IvwPAe13HGDPDz/n3/ePf24T5F+ivdw+3Wtnf3jS794XmP3Ed/XPP4sT0Ge1znP5c8Rmybi28ds6n6ocWx/Z6xxkh7tOznyOdyOk0z9n0aDXmDWRBzlb/LKRAvARiehQSHyEnA9uqxbWxxpqu0rFpRuYYrNpyTyGP6Tccg3z5pbNOP5z97T87NFPXt2bFN+fZ3ysZU8bOk1XY6oWR2zVV+Rl3Yzrbcgu0lsG1LCsr0V0eyrUXZi717pZQfHZnto8wlZ872FHNJyzbD7CpHbnW2S2uhErftMWB7CWzbClrOtlSoLbkt3y5m84u8ap12VVZQVKYEd7kykNiF7gpsT10DHN+KWxOrsT1pDVAumsv7Xd4ab9lmHx4G6XYbFYPtpbDttnIrV6MurNjIzjnj4nZhQ2C6eSOsafvpnGFsD/u4zSDbplu7mRPbySRrN/aiebXLZHFbHrZcssJ4g+1lsG3S7adUzi4vstM4y0TzoodxqzYmZ5Y3iTD96V7CQWzLDVGZ7WTyNff5sZ1gzX3l2WZEeY3R5SSyXdUuHnJtS8KPsM2vq3T1hTfW1eRjO7xlVOpc8jyzrRUv8Rgb20d+GGBWe1zTLeUmaNtFJuMWJ8tbyidmOwHbq822Dmi3XlSYLurgtmVbNxoxVbUahtnmCBw2GVX+S3KNLNqneNMAwGzT0Ex7VmzaPiYpmQ3b6ZZyQ2flW46N4QJz35ZysH2y2N59yZJs2ZZo7D5y07rZuLkRRsFLzLaN5RnbqjzmZ2VcZptwlkiqdP/HMefCdrqlXOa1rsacFuKKW8rB9knLtwlevzBDVLL12RUHGy3/fhUV2E5zElVOZwtlXIHIsq0WxbbbUi4sM9smcR97S0pbysH2yWM7j9vFjc7ysUOO0lGak+TpM23hNvnBOimUcctsLyQnSbeUZ2y7uN2zpRxx+0Sz7frYRWWpASr3omXfffjXv82fu9VZfbxQxi2zvZC5ZLql3LHt8m3du6UcbJ90tvnboNzHCvljWdlGf0lDMlQ5FSnE7UIZt8R2PObjALNi29YhU7alTqKT/i3lYPuE7XEtsq2yWpn9xp22q4cQtpKU5HuiTVKK28NwGbt2U+l7XJOFNIPvcV23uF21jV1An0KC77pEToLvKAbbYHsQ28e5VWL7/GIa2F41+1f+/wTZWJg1HwLbJ/Dal6m9df369aevl1rPwydHvlpd+yrYBp/Qgm34DVqwDS20YBtaaME2tNCCbWjBNvwGLdiG36AF29BCu3y2D6h1D0pt9MODSQ6GFtqlaRG3oUVOAr9BC7ahhRZsQwst2Ib2uGvvbJ7K2pkOPVHfubXZSdryd7JDv7KD6/mRdVHu0M/tevpyZ7Ozd/ZW+minzm8FtqFdirZ9avOO0+6d7eSEMts7O5b8h/fvnGOY+cj6TqplcPlI+vG2vX62907nd8GpNtiGdtHaej3Z2xa4D2wITuMtsX1ney9l9Oo5olMO3NlpW1x3mHyJ4u22A78uYV8ENpDzITuI29AuQ9tud868+9Jzot05nUbfzpkdxvQSQSrPtTc7Bbb5jrjqwK23E7oD6n+ZpHdIISdpZ1E7e2OwDe3CtFf3653HXmRSE3363c9t2vykfmqH43Z9x0ZuCuh5TjKA7UtnXiCS63359p1O0jlLb/BAHXEb2oVr9dV6p77PpO69/rntvTsCd/vMw8z2i2c2O9s2bN+5U4jbNpE+vZexrTt/0RG223lOwgk2DwSU3ey9owO2oV0825d29h7uXGUsNQdpC7dLqvXmizxTJFbP7PfmJC/amWZdKO+8YWdQ3OZ5J7Fdv4x8G9qlsN3eabfvbJ7eO5AEpHPGJh7tBygm1y8RzZ0zl7YvnX1HT05SP9PJ8+3k2tlOH9vtU6iTQLtMtp/b3N6sJ/sP30ks20nHxW1mu015d9LeoXhdzElchbteYPvHO8L2Tp6T2JLL3l3b23ftoU4C7RK0ncdkymdrgNtZOcPmJO290xJve9jO6ts52wfp8+WcZO+uPU7Pp8pJVvy7OqFdvvbqqVOvedZqf/bBZ9NnL1+++kC3++xrPvtb/NSzH/zZz85dld/d7gOXs4PokAdOif4ge/7WuVvPvuOWO4BeuXy5e+uNpy6flO9xhfZ4au9stgtrN92kTmUOirwcr/fPZHlzec2d4zbJXjjDNeziSuTpvb3TdRfcu23k29BCC7ahBdvwG7RgG1powTa00IJtaKEF29BCC7ahBdvwG7RgG1powTa00IJtaKEF29BCO5Bt7NuEdk21iNvQIieB36AF29BCexy0/w+iZL+2YDzJCwAAAABJRU5ErkJggg==" alt=""></p> <h2 id="_13-6-流程分析"><a href="#_13-6-流程分析" class="header-anchor">#</a> 13.6 流程分析</h2> <h3 id="_13-6-1-重新渲染组件"><a href="#_13-6-1-重新渲染组件" class="header-anchor">#</a> 13.6.1 重新渲染组件</h3> <p>再次渲染的流程从数据改变说起，在这个例子中，动态组件中<code>chooseTabs</code>数据的变化会引起依赖派发更新的过程(这个系列有三篇文章详细介绍了vue响应式系统的底层实现，感兴趣的同学可以借鉴)。简单来说，<code>chooseTabs</code>这个数据在初始化阶段会收集使用到该数据的相关依赖。当数据发生改变时，收集过的依赖会进行派发更新操作。</p> <p>其中，父组件中负责实例挂载的过程作为依赖会被执行，即执行父组件的<code>vm._update(vm._render(), hydrating);</code>。<code>_render</code>和<code>_update</code>分别代表两个过程，其中<code>_render</code>函数会根据数据的变化为组件生成新的<code>Vnode</code>节点，而<code>_update</code>最终会为新的<code>Vnode</code>生成真实的节点。而在生成真实节点的过程中，会利用<code>vitrual dom</code>的<code>diff</code>算法对前后<code>vnode</code>节点进行对比，使之尽可能少的更改真实节点，这一部分内容可以回顾<a href="https://juejin.im/post/5d3967a56fb9a07efc49cca1" target="_blank" rel="noopener noreferrer">深入剖析Vue源码 - 来，跟我一起实现diff算法!<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，里面详细阐述了利用<code>diff</code>算法进行节点差异对比的思路。</p> <p><code>patch</code>是新旧<code>Vnode</code>节点对比的过程，而<code>patchVnode</code>是其中核心的步骤，我们忽略<code>patchVnode</code>其他的流程，关注到其中对子组件执行<code>prepatch</code>钩子的过程中。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">patchVnode</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span>vnode<span class="token punctuation">,</span>insertedVnodeQueue<span class="token punctuation">,</span>ownerArray<span class="token punctuation">,</span>index<span class="token punctuation">,</span>removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ···
    <span class="token comment">// 新vnode  执行prepatch钩子</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ···
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>执行<code>prepatch</code>钩子时会拿到新旧组件的实例并执行<code>updateChildComponent</code>函数。而<code>updateChildComponent</code>会对针对新的组件实例对旧实例进行状态的更新，包括<code>props,listeners</code>等，最终会<strong>调用<code>vue</code>提供的全局<code>vm.$forceUpdate()</code>方法进行实例的重新渲染。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 之前分析的init钩子 </span>
    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">prepatch</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">prepatch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新组件实例</span>
      <span class="token keyword">var</span> options <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">;</span>
      <span class="token comment">// 旧组件实例</span>
      <span class="token keyword">var</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
      <span class="token function">updateChildComponent</span><span class="token punctuation">(</span>
        child<span class="token punctuation">,</span>
        options<span class="token punctuation">.</span>propsData<span class="token punctuation">,</span> <span class="token comment">// updated props</span>
        options<span class="token punctuation">.</span>listeners<span class="token punctuation">,</span> <span class="token comment">// updated listeners</span>
        vnode<span class="token punctuation">,</span> <span class="token comment">// new parent vnode</span>
        options<span class="token punctuation">.</span>children <span class="token comment">// new children</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateChildComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新旧的状态，不分析这个过程</span>
    ···
    <span class="token comment">// 迫使实例重新渲染。</span>
    vm<span class="token punctuation">.</span><span class="token function">$forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>先看看<code>$forceUpdate</code>做了什么操作。<code>$forceUpdate</code>是源码对外暴露的一个api，他们迫使<code>Vue</code>实例重新渲染，本质上是执行实例所收集的依赖，在例子中<code>watcher</code>对应的是<code>keep-alive</code>的<code>vm._update(vm._render(), hydrating);</code>过程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$forceUpdate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_13-6-2-重用缓存组件"><a href="#_13-6-2-重用缓存组件" class="header-anchor">#</a> 13.6.2 重用缓存组件</h3> <p>由于<code>vm.$forceUpdate()</code>会强迫<code>keep-alive</code>组件进行重新渲染，因此<code>keep-alive</code>组件会再一次执行<code>render</code>过程。这一次由于第一次对<code>vnode</code>的缓存，<code>keep-alive</code>在实例的<code>cache</code>对象中找到了缓存的组件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// keepalive组件选项</span>
<span class="token keyword">var</span> keepAlive <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>
    abstract<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到keep-alive下插槽的值</span>
      <span class="token keyword">var</span> slot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
      <span class="token comment">// 第一个vnode节点</span>
      <span class="token keyword">var</span> vnode <span class="token operator">=</span> <span class="token function">getFirstComponentChild</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 拿到第一个组件实例</span>
      <span class="token keyword">var</span> componentOptions <span class="token operator">=</span> vnode <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>componentOptions<span class="token punctuation">;</span>
      <span class="token comment">// keep-alive的第一个子组件实例存在</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// check pattern</span>
        <span class="token comment">//拿到第一个vnode节点的name</span>
        <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>componentOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> include <span class="token operator">=</span> ref<span class="token punctuation">.</span>include<span class="token punctuation">;</span>
        <span class="token keyword">var</span> exclude <span class="token operator">=</span> ref<span class="token punctuation">.</span>exclude<span class="token punctuation">;</span>
        <span class="token comment">// 通过判断子组件是否满足缓存匹配</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token comment">// not included</span>
          <span class="token punctuation">(</span>include <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>include<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token comment">// excluded</span>
          <span class="token punctuation">(</span>exclude <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>exclude<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> vnode
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> ref$<span class="token number">1</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> cache <span class="token operator">=</span> ref$<span class="token number">1.</span>cache<span class="token punctuation">;</span>
        <span class="token keyword">var</span> keys <span class="token operator">=</span> ref$<span class="token number">1.</span>keys<span class="token punctuation">;</span>
        <span class="token keyword">var</span> key <span class="token operator">=</span> vnode<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> componentOptions<span class="token punctuation">.</span>Ctor<span class="token punctuation">.</span>cid <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span>tag <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">&quot;::&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>componentOptions<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> vnode<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
          <span class="token comment">// ==== 关注点在这里 ====</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 直接取出缓存组件</span>
          vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
          <span class="token comment">// keys命中的组件名移到数组末端</span>
          <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
          keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初次渲染时，将vnode缓存</span>
          cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>
          keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// prune oldest entry</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> vnode <span class="token operator">||</span> <span class="token punctuation">(</span>slot <span class="token operator">&amp;&amp;</span> slot<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p><code>render</code>函数前面逻辑可以参考前一篇文章，由于<code>cache</code>对象中存储了再次使用的<code>vnode</code>对象，所以直接通过<code>cache[key]</code>取出缓存的组件实例并赋值给<code>vnode</code>的<code>componentInstance</code>属性。可能在读到这里的时候，会对源码中<code>keys</code>这个数组的作用，以及<code>pruneCacheEntry</code>的功能有疑惑，这里我们放到文章末尾讲缓存优化策略时解答。</p> <h3 id="_13-6-3-真实节点的替换"><a href="#_13-6-3-真实节点的替换" class="header-anchor">#</a> 13.6.3 真实节点的替换</h3> <p>执行了<code>keep-alive</code>组件的<code>_render</code>过程，接下来是<code>_update</code>产生真实的节点，同样的，<code>keep-alive</code>下有<code>child1</code>子组件，所以<code>_update</code>过程会调用<code>createComponent</code>递归创建子组件<code>vnode</code>,这个过程在初次渲染时也有分析过，我们可以对比一下，再次渲染时流程有哪些不同。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createComponent</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// vnode为缓存的vnode</span>
      <span class="token keyword">var</span> i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 此时isReactivated为true</span>
        <span class="token keyword">var</span> isReactivated <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>keepAlive<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* hydrating */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 其中一个作用是保留真实dom到vnode中</span>
          <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>此时的<code>vnode</code>是缓存取出的子组件<code>vnode</code></strong>，并且由于在第一次渲染时对组件进行了标记<code>vnode.data.keepAlive = true;</code>,所以<code>isReactivated</code>的值为<code>true</code>,<code>i.init</code>依旧会执行子组件的初始化过程。但是这个过程由于有缓存，所以执行过程也不完全相同。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">init</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>_isDestroyed <span class="token operator">&amp;&amp;</span>
        vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当有keepAlive标志时，执行prepatch钩子</span>
        <span class="token keyword">var</span> mountedNode <span class="token operator">=</span> vnode<span class="token punctuation">;</span> <span class="token comment">// work around flow</span>
        componentVNodeHooks<span class="token punctuation">.</span><span class="token function">prepatch</span><span class="token punctuation">(</span>mountedNode<span class="token punctuation">,</span> mountedNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> <span class="token function">createComponentInstanceForVnode</span><span class="token punctuation">(</span>
          vnode<span class="token punctuation">,</span>
          activeInstance
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        child<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>hydrating <span class="token operator">?</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>显然因为有<code>keepAlive</code>的标志，所以子组件不再走挂载流程，只是执行<code>prepatch</code>钩子对组件状态进行更新。并且很好的利用了缓存<code>vnode</code>之前保留的真实节点进行节点的替换。</p> <h2 id="_13-7-生命周期"><a href="#_13-7-生命周期" class="header-anchor">#</a> 13.7 生命周期</h2> <p>我们通过例子来观察<code>keep-alive</code>生命周期和普通组件的不同。</p> <p><img src="/book-docs/vue-depth-analysisassets/img/13.4.afbe98ad.gif" alt=""></p> <p>在我们从<code>child1</code>切换到<code>child2</code>,再切回<code>child1</code>过程中，<code>chil1</code>不会再执行<code>mounted</code>钩子，只会执行<code>activated</code>钩子，而<code>child2</code>也不会执行<code>destoryed</code>钩子，只会执行<code>deactivated</code>钩子，这是为什么？<code>child2</code>的<code>deactivated</code>钩子又要比<code>child1</code>的<code>activated</code>提前执行，这又是为什么？</p> <h3 id="_13-7-1-deactivated"><a href="#_13-7-1-deactivated" class="header-anchor">#</a> 13.7.1 deactivated</h3> <p>我们先从组件的销毁开始说起，当<code>child1</code>切换到<code>child2</code>时，<code>child1</code>会执行<code>deactivated</code>钩子而不是<code>destoryed</code>钩子，这是为什么？
前面分析<code>patch</code>过程会对新旧节点的改变进行对比，从而尽可能范围小的去操作真实节点，当完成<code>diff</code>算法并对节点操作完毕后，接下来还有一个重要的步骤是<strong>对旧的组件执行销毁移除操作</strong>。这一步的代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">···</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 分析过的patchVnode过程</span>
  <span class="token comment">// 销毁旧节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">removeVnodes</span> <span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> vnodes<span class="token punctuation">,</span> startIdx<span class="token punctuation">,</span> endIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// startIdx,endIdx都为0</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ch 会拿到需要销毁的组件</span>
    <span class="token keyword">var</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 真实节点的移除操作</span>
        <span class="token function">removeAndInvokeRemoveHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// Text node</span>
        <span class="token function">removeNode</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><code>removeAndInvokeRemoveHook</code>会对旧的节点进行移除操作，其中关键的一步是会将真实节点从父元素中删除，有兴趣可以自行查看这部分逻辑。<code>invokeDestroyHook</code>是执行销毁组件钩子的核心。如果该组件下存在子组件，会递归去调用<code>invokeDestroyHook</code>执行销毁操作。销毁过程会执行组件内部的<code>destory</code>钩子。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">invokeDestroyHook</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>destroy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
      <span class="token comment">// 执行组件内部destroy钩子</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果组件存在子组件，则遍历子组件去递归调用invokeDestoryHook执行钩子</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>组件内部钩子前面已经介绍了<code>init</code>和<code>prepatch</code>钩子，而<code>destroy</code>钩子的逻辑更加简单。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">destroy</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">destroy</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 组件实例</span>
    <span class="token keyword">var</span> componentInstance <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
    <span class="token comment">// 如果实例还未被销毁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不是keep-alive组件则执行销毁操作</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        componentInstance<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果是已经缓存的组件</span>
        <span class="token function">deactivateChildComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* direct */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>当组件是<code>keep-alive</code>缓存过的组件，即已经用<code>keepAlive</code>标记过，则不会执行实例的销毁，即<code>componentInstance.$destroy()</code>的过程。<code>$destroy</code>过程会做一系列的组件销毁操作，其中的<code>beforeDestroy,destoryed</code>钩子也是在<code>$destory</code>过程中调用，而<code>deactivateChildComponent</code>的处理过程却完全不同。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deactivateChildComponent</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> direct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>direct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// </span>
    vm<span class="token punctuation">.</span>_directInactive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInInactiveTree</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span>_inactive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 已经被停用</span>
    vm<span class="token punctuation">.</span>_inactive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 对子组件同样会执行停用处理</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vm<span class="token punctuation">.</span>$children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">deactivateChildComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 最终调用deactivated钩子</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'deactivated'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>_directInactive</code>是用来标记这个被打上停用标签的组件是否是最顶层的组件。而<code>_inactive</code>是停用的标志，同样的子组件也需要递归去调用<code>deactivateChildComponent</code>,打上停用的标记。<strong>最终会执行用户定义的<code>deactivated</code>钩子。</strong></p> <h3 id="_13-7-2-activated"><a href="#_13-7-2-activated" class="header-anchor">#</a> 13.7.2 activated</h3> <p>现在回过头看看<code>activated</code>的执行时机，同样是<code>patch</code>过程，在对旧节点移除并执行销毁或者停用的钩子后，对新节点也会执行相应的钩子。<strong>这也是停用的钩子比启用的钩子先执行的原因。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">···</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// patchVnode过程</span>
  <span class="token comment">// 销毁旧节点</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 执行组件内部的insert钩子</span>
  <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> isInitialPatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">invokeInsertHook</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> initial</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// delay insert hooks for component root nodes, invoke them after the</span>
  <span class="token comment">// 当节点已经被插入时，会延迟执行insert钩子</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vnode<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pendingInsert <span class="token operator">=</span> queue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>同样的组件内部的<code>insert</code>钩子逻辑如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 组件内部自带钩子</span>
  <span class="token keyword">var</span> componentVNodeHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">insert</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">insert</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> context <span class="token operator">=</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">;</span>
      <span class="token keyword">var</span> componentInstance <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
      <span class="token comment">// 实例已经被挂载</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentInstance<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        componentInstance<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// vue-router#1212</span>
          <span class="token comment">// During updates, a kept-alive component's child components may</span>
          <span class="token comment">// change, so directly walking the tree here may call activated hooks</span>
          <span class="token comment">// on incorrect children. Instead we push them into a queue which will</span>
          <span class="token comment">// be processed after the whole patch process ended.</span>
          <span class="token function">queueActivatedComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">activateChildComponent</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* direct */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>当第一次实例化组件时，由于实例的<code>_isMounted</code>不存在，所以会调用<code>mounted</code>钩子，当我们从<code>child2</code>再次切回<code>child1</code>时，由于<code>child1</code>只是被停用而没有被销毁，所以不会再调用<code>mounted</code>钩子，此时会执行<code>activateChildComponent</code>函数对组件的状态进行处理。有了分析<code>deactivateChildComponent</code>的基础，<code>activateChildComponent</code>的逻辑也很好理解，同样的<code>_inactive</code>标记为已启用，并且对子组件递归调用<code>activateChildComponent</code>做状态处理。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">activateChildComponent</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> direct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>direct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_directInactive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInInactiveTree</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_directInactive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_inactive <span class="token operator">||</span> vm<span class="token punctuation">.</span>_inactive <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_inactive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vm<span class="token punctuation">.</span>$children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">activateChildComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'activated'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="_13-8-缓存优化-lru"><a href="#_13-8-缓存优化-lru" class="header-anchor">#</a> 13.8 缓存优化 - LRU</h2> <p>程序的内存空间是有限的，所以我们无法无节制的对数据进行存储，这时候需要有策略去淘汰不那么重要的数据，保持最大数据存储量的一致。这种类型的策略称为缓存优化策略，根据淘汰的机制不同，常用的有以下三类。</p> <p><strong>1.FIFO： 先进先出策略，我们通过记录数据使用的时间，当缓存大小即将溢出时，优先清除离当前时间最远的数据。</strong></p> <p><strong>2.LRU： 最近最少使用。LRU策略遵循的原则是，如果数据最近被访问(使用)过，那么将来被访问的几率会更高，如果以一个数组去记录数据，当有一数据被访问时，该数据会被移动到数组的末尾，表明最近被使用过，当缓存溢出时，会删除数组的头部数据，即将最不频繁使用的数据移除。</strong></p> <p><strong>3.LFU: 计数最少策略。用次数去标记数据使用频率，次数最少的会在缓存溢出时被淘汰。</strong></p> <p>这三种缓存算法各有优劣，各自适用不同场景，而我们看<code>keep-alive</code>在缓存时的优化处理，很明显利用了<code>LRU</code>的缓存策略。我们看关键的代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> keepAlive <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ···
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
      <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>
      keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pruneCacheEntry</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">remove</span> <span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>结合一个实际的例子分析缓存逻辑的实现。
1.有三个组件<code>child1,child2,child3</code>,<code>keep-alive</code>的最大缓存个数设置为2
2.用<code>cache</code>对象去存储组件<code>vnode</code>,<code>key</code>为组件名字，<code>value</code>为组件<code>vnode</code>对象，用<code>keys</code>数组去记录组件名字，由于是数组，所以<code>keys</code>为有序。
3.<code>child1,child2</code>组件依次访问，缓存结果为</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'child1'</span><span class="token punctuation">,</span> <span class="token string">'child2'</span><span class="token punctuation">]</span>
cache <span class="token operator">=</span> <span class="token punctuation">{</span>
  child1<span class="token operator">:</span> child1Vnode<span class="token punctuation">,</span>
  child2<span class="token operator">:</span> child2Vnode
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>4.再次访问到<code>child1</code>组件，由于命中了缓存，会调用<code>remove</code>方法把<code>keys</code>中的<code>child1</code>删除，并通过数组的<code>push</code>方法将<code>child1</code>推到尾部。缓存结果修改为</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'child2'</span><span class="token punctuation">,</span> <span class="token string">'child1'</span><span class="token punctuation">]</span>
cache <span class="token operator">=</span> <span class="token punctuation">{</span>
  child1<span class="token operator">:</span> child1Vnode<span class="token punctuation">,</span>
  child2<span class="token operator">:</span> child2Vnode
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>5.访问到<code>child3</code>时，由于缓存个数限制，初次缓存会执行<code>pruneCacheEntry</code>方法对最少访问到的数据进行删除。<code>pruneCacheEntry</code>的定义如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">pruneCacheEntry</span> <span class="token punctuation">(</span><span class="token parameter">cache<span class="token punctuation">,</span>key<span class="token punctuation">,</span>keys<span class="token punctuation">,</span>current</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> cached###<span class="token number">1</span> <span class="token operator">=</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 销毁实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cached###<span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>current <span class="token operator">||</span> cached###<span class="token number">1.</span>tag <span class="token operator">!==</span> current<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cached###<span class="token number">1.</span>componentInstance<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">remove</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>删除缓存时会把<code>keys[0]</code>代表的组件删除，由于之前的处理，最近被访问到的元素会位于数组的尾部，所以头部的数据往往是最少访问的，因此会优先删除头部的元素。并且会再次调用<code>remove</code>方法，将<code>keys</code>的首个元素删除。</p> <p>这就是<code>vue</code>中对<code>keep-alive</code>缓存处理的优化过程。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html" class="prev">
        彻底搞懂Vue中keep-alive的魔法-上.md
      </a></span> <span class="next"><a href="/book-docs/vue-depth-analysis/揭秘Vue的事件机制.html">
        揭秘Vue的事件机制.md
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/book-docs/vue-depth-analysis/assets/js/app.186b0384.js" defer></script><script src="/book-docs/vue-depth-analysis/assets/js/2.d669090a.js" defer></script><script src="/book-docs/vue-depth-analysis/assets/js/13.ce31926b.js" defer></script>
  </body>
</html>
