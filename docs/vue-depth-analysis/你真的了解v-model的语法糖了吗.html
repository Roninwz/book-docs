<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>技术文档</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="技术文档">
    
    <link rel="preload" href="/book-docs/vue-depth-analysis/assets/css/0.styles.8591e10b.css" as="style"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/app.51ae15a7.js" as="script"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/2.d669090a.js" as="script"><link rel="preload" href="/book-docs/vue-depth-analysis/assets/js/9.46e95ee8.js" as="script"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/10.efbf1bb7.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/11.a0855ea9.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/12.04b8c6b2.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/13.ff3a7173.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/14.2b998cb4.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/15.7cc6e804.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/16.69094c9a.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/17.9e8b0e3b.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/18.d302e10a.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/19.bb0ceb6c.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/20.e08a7e67.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/21.584bac77.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/22.f5a9ebe3.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/23.6412c5c7.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/3.c431a2cd.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/4.39dec256.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/5.91555d41.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/6.df985286.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/7.84a5236c.js"><link rel="prefetch" href="/book-docs/vue-depth-analysis/assets/js/8.b732416c.js">
    <link rel="stylesheet" href="/book-docs/vue-depth-analysis/assets/css/0.styles.8591e10b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/book-docs/vue-depth-analysis/" class="home-link router-link-active"><!----> <span class="site-name">技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/book-docs/vue-depth-analysis/vue插槽，你想了解的都在这里.html" class="sidebar-link">vue插槽，你想了解的都在这里.md</a></li><li><a href="/book-docs/vue-depth-analysis/丰富的选项合并策略.html" class="sidebar-link">丰富的选项合并策略.md</a></li><li><a href="/book-docs/vue-depth-analysis/你真的了解v-model的语法糖了吗.html" class="active sidebar-link">你真的了解v-model的语法糖了吗.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/你真的了解v-model的语法糖了吗.html#_11-1-表单绑定" class="sidebar-link">11.1 表单绑定</a></li><li class="sidebar-sub-header"><a href="/book-docs/vue-depth-analysis/你真的了解v-model的语法糖了吗.html#_11-2-组件使用v-model" class="sidebar-link">11.2 组件使用v-model</a></li></ul></li><li><a href="/book-docs/vue-depth-analysis/动态组件的深入分析.html" class="sidebar-link">动态组件的深入分析.md</a></li><li><a href="/book-docs/vue-depth-analysis/基础的数据代理检测.html" class="sidebar-link">基础的数据代理检测.md</a></li><li><a href="/book-docs/vue-depth-analysis/完整渲染流程.html" class="sidebar-link">完整渲染流程.md</a></li><li><a href="/book-docs/vue-depth-analysis/实例挂载流程和模板编译.html" class="sidebar-link">实例挂载流程和模板编译.md</a></li><li><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-上.html" class="sidebar-link">彻底搞懂Vue中keep-alive的魔法-上.md</a></li><li><a href="/book-docs/vue-depth-analysis/彻底搞懂Vue中keep-alive的魔法-下.html" class="sidebar-link">彻底搞懂Vue中keep-alive的魔法-下.md</a></li><li><a href="/book-docs/vue-depth-analysis/揭秘Vue的事件机制.html" class="sidebar-link">揭秘Vue的事件机制.md</a></li><li><a href="/book-docs/vue-depth-analysis/来，跟我一起实现diff算法.html" class="sidebar-link">来，跟我一起实现diff算法.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-上.html" class="sidebar-link">深入响应式系统构建-上.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-下.html" class="sidebar-link">深入响应式系统构建-下.md</a></li><li><a href="/book-docs/vue-depth-analysis/深入响应式系统构建-中.html" class="sidebar-link">深入响应式系统构建-中.md</a></li><li><a href="/book-docs/vue-depth-analysis/组件基础剖析.html" class="sidebar-link">组件基础剖析.md</a></li><li><a href="/book-docs/vue-depth-analysis/组件高级用法.html" class="sidebar-link">组件高级用法.md</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>双向数据绑定这个概念或者大家并不陌生，视图影响数据，数据同样影响视图，两者间有双向依赖的关系。在响应式系统构建的上，中，下篇我已经对数据影响视图的原理详细阐述清楚了。而如何完成视图影响数据这一关联？这就是本节讨论的重点：指令<code>v-model</code>。</p></blockquote> <p>由于<code>v-model</code>和前面介绍的插槽，事件一致，都属于vue提供的指令，所以我们对<code>v-model</code>的分析方式和以往大同小异。分析会围绕模板的编译，<code>render</code>函数的生成，到最后真实节点的挂载顺序执行。最终我们依然会得到一个结论，<strong>v-model无论什么使用场景，本质上都是一个语法糖</strong>。</p> <h2 id="_11-1-表单绑定"><a href="#_11-1-表单绑定" class="header-anchor">#</a> 11.1 表单绑定</h2> <h3 id="_11-1-1-基础使用"><a href="#_11-1-1-基础使用" class="header-anchor">#</a> 11.1.1 基础使用</h3> <p><code>v-model</code>和表单脱离不了关系，之所以视图能影响数据，本质上这个视图需要可交互的，因此表单是实现这一交互的前提。表单的使用以<code>&lt;input &gt; &lt;textarea&gt; &lt;select&gt;</code>为核心，更细的划分结合<code>v-model</code>的使用如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>// 普通输入框
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

// 多行文本框
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>30<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>

// 单选框
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>group<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>radio<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> one
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>radio<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>two<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> two
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span> 

// 原生单选框的写法 注：原生单选框的写法需要通过name绑定一组单选，两个radio的name属性相同，才能表现为互斥
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>group<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>radio<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>one
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>radio<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>two<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>two
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>


// 多选框  (原始值： value4: [])
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>group<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jack<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>jack
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>lili<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>lili
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

// 下拉选项
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value5<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>apple<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>apple<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>banana<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>banana<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bear<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>bear<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>接下来的分析，我们以普通输入框为例</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">&quot;value1&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      value1<span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>进入正文前先回顾一下模板到真实节点的过程。</p> <ol><li>模板解析成<code>AST</code>树;</li> <li><code>AST</code>树生成可执行的<code>render</code>函数;</li> <li><code>render</code>函数转换为<code>Vnode</code>对象;</li> <li>根据<code>Vnode</code>对象生成真实的<code>Dom</code>节点。</li></ol> <p>接下来，我们先看看模板解析为<code>AST</code>树的过程。</p> <h3 id="_11-1-2-ast树的解析"><a href="#_11-1-2-ast树的解析" class="header-anchor">#</a> 11.1.2 AST树的解析</h3> <p>模板的编译阶段，会调用<code>var ast = parse(template.trim(), options)</code>生成<code>AST</code>树，<code>parse</code>函数的其他细节这里不展开分析，前面的文章或多或少都涉及过，我们还是把关注点放在模板属性上的解析，也就是<code>processAttrs</code>函数上。</p> <p>使用过<code>vue</code>写模板的都知道，<code>vue</code>模板属性由两部分组成，一部分是指令，另一部分是普通<code>html</code>标签属性。z这也是属性处理的两大分支。而在指令的细分领域，又将<code>v-on，v-bind</code>做特殊的处理，其他的普通分支会执行<code>addDirective</code>过程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 处理模板属性</span>
<span class="token keyword">function</span> <span class="token function">processAttrs</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> list <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsList<span class="token punctuation">;</span>
  <span class="token keyword">var</span> i<span class="token punctuation">,</span> l<span class="token punctuation">,</span> name<span class="token punctuation">,</span> rawName<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">,</span> syncGen<span class="token punctuation">,</span> isDynamic<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name <span class="token operator">=</span> rawName <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span> <span class="token comment">// v-on:click</span>
    value <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// doThis</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 1.针对指令的属性处理</span>
      ···
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bindRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// v-bind分支</span>
        ···
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>onRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// v-on分支</span>
        ···
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 除了v-bind，v-on之外的普通指令</span>
        ···
        <span class="token comment">// 普通指令会在AST树上添加directives属性</span>
        <span class="token function">addDirective</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> name<span class="token punctuation">,</span> rawName<span class="token punctuation">,</span> value<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> isDynamic<span class="token punctuation">,</span> modifiers<span class="token punctuation">,</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'model'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">checkForAliasModel</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2. 普通html标签属性</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在揭秘事件机制这一节，我们介绍了<code>AST</code>产生阶段对事件指令<code>v-on</code>的处理是为<code>AST</code>树添加<code>events</code>属性。类似的，普通指令会在<code>AST</code>树上添加<code>directives</code>属性，具体看<code>addDirective</code>函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 添加directives属性</span>
<span class="token keyword">function</span> <span class="token function">addDirective</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span>name<span class="token punctuation">,</span>rawName<span class="token punctuation">,</span>value<span class="token punctuation">,</span>arg<span class="token punctuation">,</span>isDynamicArg<span class="token punctuation">,</span>modifiers<span class="token punctuation">,</span>range</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>el<span class="token punctuation">.</span>directives <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">rangeSetItem</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> name<span class="token punctuation">,</span>
      rawName<span class="token operator">:</span> rawName<span class="token punctuation">,</span>
      value<span class="token operator">:</span> value<span class="token punctuation">,</span>
      arg<span class="token operator">:</span> arg<span class="token punctuation">,</span>
      isDynamicArg<span class="token operator">:</span> isDynamicArg<span class="token punctuation">,</span>
      modifiers<span class="token operator">:</span> modifiers
    <span class="token punctuation">}</span><span class="token punctuation">,</span> range<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    el<span class="token punctuation">.</span>plain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>最终<code>AST</code>树多了一个属性对象，其中<code>modifiers</code>代表模板中添加的修饰符，如：<code>.lazy, .number, .trim</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// AST</span>
<span class="token punctuation">{</span>
  directives<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
      rawName<span class="token operator">:</span> <span class="token string">'v-model'</span><span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">'value'</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'v-model'</span><span class="token punctuation">,</span>
      modifiers<span class="token operator">:</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_11-1-3-render函数生成"><a href="#_11-1-3-render函数生成" class="header-anchor">#</a> 11.1.3 render函数生成</h3> <p><code>render</code>函数生成阶段，也就是前面分析了数次的<code>generate</code>逻辑，其中<code>genData</code>会对模板的诸多属性进行处理,最终返回拼接好的字符串模板，而对指令的处理会进入<code>genDirectives</code>流程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genData</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">'{'</span><span class="token punctuation">;</span>
  <span class="token comment">// 指令的处理</span>
  <span class="token keyword">var</span> dirs <span class="token operator">=</span> <span class="token function">genDirectives</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ··· <span class="token comment">// 其他属性，指令的处理</span>
  <span class="token comment">// 针对组件的v-model处理，放到后面分析</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token string">&quot;model:{value:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>model<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,callback:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>model<span class="token punctuation">.</span>callback<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,expression:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>model<span class="token punctuation">.</span>expression<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;},&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>genDirectives</code>逻辑并不复杂,他会拿到之前<code>AST</code>树中保留的<code>directives</code>对象，并遍历解析指令对象，最终以<code>'directives:['</code>包裹的字符串返回。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// directives render字符串的生成</span>
  <span class="token keyword">function</span> <span class="token function">genDirectives</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拿到指令对象</span>
    <span class="token keyword">var</span> dirs <span class="token operator">=</span> el<span class="token punctuation">.</span>directives<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirs<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    <span class="token comment">// 字符串拼接</span>
    <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token string">'directives:['</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> hasRuntime <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> i<span class="token punctuation">,</span> l<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> needRuntime<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> dirs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dir <span class="token operator">=</span> dirs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      needRuntime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 对指令ast树的重新处理</span>
      <span class="token keyword">var</span> gen <span class="token operator">=</span> state<span class="token punctuation">.</span>directives<span class="token punctuation">[</span>dir<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>gen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// compile-time directive that manipulates AST.</span>
        <span class="token comment">// returns true if it also needs a runtime counterpart.</span>
        needRuntime <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">gen</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> state<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>needRuntime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasRuntime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        res <span class="token operator">+=</span> <span class="token string">&quot;{name:\&quot;&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;,rawName:\&quot;&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>rawName<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>value <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">&quot;,value:(&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;),expression:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>arg <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">&quot;,arg:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>isDynamicArg <span class="token operator">?</span> dir<span class="token punctuation">.</span>arg <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">&quot;\&quot;&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>arg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>modifiers <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">&quot;,modifiers:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;},&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasRuntime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">']'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>这里有一句关键的代码<code>var gen = state.directives[dir.name]</code>,为了了解其来龙去脉，我们回到Vue源码中的编译流程，在以往的文章中，我们完整的介绍过<code>template</code>模板的编译流程,这一部分的设计是非常复杂且巧妙的，其中大量运用了偏函数的思想，即分离了不同平台不同的编译过程，也为同一个平台每次提供相同的配置选项进行了合并处理，并很好的将配置进行了缓存。其中针对浏览器端有三个重要的指令选项。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> directive$<span class="token number">1</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  model<span class="token operator">:</span> model<span class="token punctuation">,</span>
  text<span class="token operator">:</span> text<span class="token punctuation">,</span>
  html<span class="token punctuation">,</span> html
<span class="token punctuation">}</span>
<span class="token keyword">var</span> baseOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  ···
  <span class="token comment">// 指令选项</span>
  directives<span class="token operator">:</span> directives$<span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 编译时传入选项配置</span>
<span class="token function">createCompiler</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>而这个<code>state.directives['model']</code>也就是对应的<code>model</code>函数，所以我们先把焦点聚焦在<code>model</code>函数的逻辑。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">model</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span>dir<span class="token punctuation">,</span>_warn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    warn$<span class="token number">1</span> <span class="token operator">=</span> _warn<span class="token punctuation">;</span>
    <span class="token comment">// 绑定的值</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> dir<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">var</span> modifiers <span class="token operator">=</span> dir<span class="token punctuation">.</span>modifiers<span class="token punctuation">;</span>
    <span class="token keyword">var</span> tag <span class="token operator">=</span> el<span class="token punctuation">.</span>tag<span class="token punctuation">;</span>
    <span class="token keyword">var</span> type <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// 这里遇到type是file的html，如果还使用双向绑定会报出警告。</span>
      <span class="token comment">// 因为File inputs是只读的</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'input'</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">===</span> <span class="token string">'file'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn$1</span><span class="token punctuation">(</span>
          <span class="token string">&quot;&lt;&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; v-model=\&quot;&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">&quot;\&quot; type=\&quot;file\&quot;&gt;:\n&quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;File inputs are read only. Use a v-on:change listener instead.&quot;</span><span class="token punctuation">,</span>
          el<span class="token punctuation">.</span>rawAttrsMap<span class="token punctuation">[</span><span class="token string">'v-model'</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//组件上v-model的处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">genComponentModel</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// component v-model doesn't need extra runtime</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'select'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// select表单</span>
      <span class="token function">genSelect</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'input'</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">===</span> <span class="token string">'checkbox'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// checkbox表单</span>
      <span class="token function">genCheckboxModel</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'input'</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">===</span> <span class="token string">'radio'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// radio表单</span>
      <span class="token function">genRadioModel</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> <span class="token string">'input'</span> <span class="token operator">||</span> tag <span class="token operator">===</span> <span class="token string">'textarea'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 普通input，如 text, textarea</span>
      <span class="token function">genDefaultModel</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">genComponentModel</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// component v-model doesn't need extra runtime</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果不是表单使用v-model，同样会报出警告，双向绑定只针对表单控件。</span>
      <span class="token function">warn$1</span><span class="token punctuation">(</span>
        <span class="token string">&quot;&lt;&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; v-model=\&quot;&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">&quot;\&quot;&gt;: &quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;v-model is not supported on this element type. &quot;</span> <span class="token operator">+</span>
        <span class="token string">'If you are working with contenteditable, it\'s recommended to '</span> <span class="token operator">+</span>
        <span class="token string">'wrap a library dedicated for that purpose inside a custom component.'</span><span class="token punctuation">,</span>
        el<span class="token punctuation">.</span>rawAttrsMap<span class="token punctuation">[</span><span class="token string">'v-model'</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ensure runtime directive metadata</span>
    <span class="token comment">// </span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>显然，<strong><code>model</code>会对表单控件的<code>AST</code>树做进一步的处理</strong>，在上面的基础用法中，我们知道<strong>表单有不同的类型，每种类型对应的事件处理响应机制也不同</strong>。因此我们需要针对不同的表单控件生成不同的<code>render</code>函数，因此需要产生不同的<code>AST</code>属性。<code>model</code>针对不同类型的表单控件有不同的处理分支。我们重点分析普通<code>input</code>标签的处理，<code>genDefaultModel</code>分支，其他类型的分支，可以仿照下面的分析过程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genDefaultModel</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span>value<span class="token punctuation">,</span>modifiers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> type <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">.</span>type<span class="token punctuation">;</span>

    <span class="token comment">// v-model和v-bind值相同值，有冲突会报错</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">var</span> value$<span class="token number">1</span> <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'v-bind:value'</span><span class="token punctuation">]</span> <span class="token operator">||</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">':value'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> typeBinding <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'v-bind:type'</span><span class="token punctuation">]</span> <span class="token operator">||</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">':type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value$<span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>typeBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> binding <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'v-bind:value'</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token string">'v-bind:value'</span> <span class="token operator">:</span> <span class="token string">':value'</span><span class="token punctuation">;</span>
        <span class="token function">warn$1</span><span class="token punctuation">(</span>
          binding <span class="token operator">+</span> <span class="token string">&quot;=\&quot;&quot;</span> <span class="token operator">+</span> value$<span class="token number">1</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot; conflicts with v-model on the same element &quot;</span> <span class="token operator">+</span>
          <span class="token string">'because the latter already expands to a value binding internally'</span><span class="token punctuation">,</span>
          el<span class="token punctuation">.</span>rawAttrsMap<span class="token punctuation">[</span>binding<span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// modifiers存贮的是v-model的修饰符。</span>
    <span class="token keyword">var</span> ref <span class="token operator">=</span> modifiers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// lazy,trim,number是可供v-model使用的修饰符</span>
    <span class="token keyword">var</span> lazy <span class="token operator">=</span> ref<span class="token punctuation">.</span>lazy<span class="token punctuation">;</span>
    <span class="token keyword">var</span> number <span class="token operator">=</span> ref<span class="token punctuation">.</span>number<span class="token punctuation">;</span>
    <span class="token keyword">var</span> trim <span class="token operator">=</span> ref<span class="token punctuation">.</span>trim<span class="token punctuation">;</span>
    <span class="token keyword">var</span> needCompositionGuard <span class="token operator">=</span> <span class="token operator">!</span>lazy <span class="token operator">&amp;&amp;</span> type <span class="token operator">!==</span> <span class="token string">'range'</span><span class="token punctuation">;</span>
    <span class="token comment">// lazy修饰符将触发同步的事件从input改为change</span>
    <span class="token keyword">var</span> event <span class="token operator">=</span> lazy <span class="token operator">?</span> <span class="token string">'change'</span> <span class="token operator">:</span> type <span class="token operator">===</span> <span class="token string">'range'</span> <span class="token operator">?</span> <span class="token constant">RANGE_TOKEN</span> <span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> valueExpression <span class="token operator">=</span> <span class="token string">'$event.target.value'</span><span class="token punctuation">;</span>
    <span class="token comment">// 过滤用户输入的首尾空白符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      valueExpression <span class="token operator">=</span> <span class="token string">&quot;$event.target.value.trim()&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将用户输入转为数值类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      valueExpression <span class="token operator">=</span> <span class="token string">&quot;_n(&quot;</span> <span class="token operator">+</span> valueExpression <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// genAssignmentCode函数是为了处理v-model的格式，允许使用以下的形式： v-model=&quot;a.b&quot; v-model=&quot;a[b]&quot;</span>
    <span class="token keyword">var</span> code <span class="token operator">=</span> <span class="token function">genAssignmentCode</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> valueExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>needCompositionGuard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//  保证了不会在输入法组合文字过程中得到更新</span>
      code <span class="token operator">=</span> <span class="token string">&quot;if($event.target.composing)return;&quot;</span> <span class="token operator">+</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//  添加value属性</span>
    <span class="token function">addProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绑定事件</span>
    <span class="token function">addHandler</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> event<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trim <span class="token operator">||</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">addHandler</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'blur'</span><span class="token punctuation">,</span> <span class="token string">'$forceUpdate()'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">genAssignmentCode</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span>assignment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理v-model的格式，v-model=&quot;a.b&quot; v-model=&quot;a[b]&quot;</span>
  <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token function">parseModel</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 普通情形</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>value <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> assignment<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对象形式</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">&quot;$set(&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>exp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> assignment <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p><code>genDefaultModel</code>的逻辑有两部分，<strong>一部分是针对修饰符产生不同的事件处理字符串，二是为<code>v-model</code>产生的<code>AST</code>树添加属性和事件相关的属性</strong>。其中最重要的两行代码是</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//  添加value属性</span>
<span class="token function">addProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 绑定事件属性</span>
<span class="token function">addHandler</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> event<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>addHandler</code>在之前介绍事件时分析过，他会为<code>AST</code>树添加事件相关的属性,同样的<code>addProp</code>也会为<code>AST</code>树添加<code>props</code>属性。最终<code>AST</code>树新增了两个属性：</p> <p><img src="data:image/png;base64,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" alt=""></p> <p>回到<code>genData</code>,通过<code>genDirectives</code>处理后，原先的<code>AST</code>树新增了两个属性，因此在字符串生成阶段同样需要处理<code>props</code>和<code>events</code>的分支。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genData$2</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">'{'</span><span class="token punctuation">;</span>
  <span class="token comment">// 已经分析过的genDirectives</span>
  <span class="token keyword">var</span> dirs <span class="token operator">=</span> <span class="token function">genDirectives</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 处理props</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token string">&quot;domProps:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">genProps</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 处理事件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token function">genHandlers</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>最终<code>render</code>函数的结果为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;_c('input',{directives:[{name:&quot;</span>model<span class="token string">&quot;,rawName:&quot;</span>v<span class="token operator">-</span>model<span class="token string">&quot;,value:(message),expression:&quot;</span>message<span class="token string">&quot;}],attrs:{&quot;</span>type<span class="token string">&quot;:&quot;</span>text<span class="token string">&quot;},domProps:{&quot;</span>value<span class="token string">&quot;:(message)},on:{&quot;</span>input<span class="token string">&quot;:function($event){if($event.target.composing)return;message=$event.target.value}}})&quot;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">&quot;value&quot;</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果觉得上面的流程分析啰嗦，可以直接看下面的结论，对比模板和生成的<code>render</code>函数,我们可以得到：</p> <ol><li><code>input</code>标签所有属性，包括指令相关的内容都是以<code>data</code>属性的形式作为参数的整体传入<code>_c(即：createElement)</code>函数。</li> <li><code>input type</code>的类型，在<code>data</code>属性中，以<code>attrs</code>键值对存在。</li> <li><code>v-model</code>会有对应的<code>directives</code>属性描述指令的相关信息。</li> <li><strong>为什么说<code>v-model</code>是一个语法糖，从<code>render</code>函数的最终结果可以看出，它最终以两部分形式存在于<code>input</code>标签中，一个是将<code>value1</code>以<code>props</code>的形式存在(<code>domProps</code>)中，另一个是以事件的形式存储<code>input</code>事件，并保留在<code>on</code>属性中。</strong></li> <li>重要的一个关键，事件用<code>$event.target.composing</code>属性来保证不会在输入法组合文字过程中更新数据,这点我们后面会再次提到。</li></ol> <h3 id="_11-1-4-patch真实节点"><a href="#_11-1-4-patch真实节点" class="header-anchor">#</a> 11.1.4 patch真实节点</h3> <p>在<code>patch</code>之前还有一个生成<code>vnode</code>的过程，这个过程没有什么特别之处，所有的包括指令，属性会以<code>data</code>属性的形式传递到构造函数<code>Vnode</code>中，最终的<code>Vnode</code>拥有<code>directives,domProps,on</code>属性：</p> <p><img src="data:image/png;base64,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" alt=""></p> <p>有了<code>Vnode</code>之后紧接着会执行<code>patchVnode</code>,<code>patchVnode</code>过程是一个真实节点创建的过程，其中的关键是<code>createElm</code>方法，这个方法我们在不同的场合也分析过，前面的源码得到指令相关的信息也会保留在<code>vnode</code>的<code>data</code>属性里，所以对属性的处理也会走<code>invokeCreateHooks</code>逻辑。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createElm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ···
  <span class="token comment">// 针对指令的处理</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">invokeCreateHooks</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>invokeCreateHooks</code>会调用定义好的钩子函数，对<code>vnode</code>上定义的属性，指令，事件等进行真实DOM的处理，步骤包括以下(不包含全部)：</p> <ol><li><code>updateDOMProps</code>会利用<code>vnode data</code>上的<code>domProps</code>更新<code>input</code>标签的<code>value</code>值;</li> <li><code>updateAttrs</code>会利用<code>vnode data</code>上的<code>attrs</code>属性更新节点的属性值;</li> <li><code>updateDomListeners</code>利用<code>vnode data</code>上的<code>on</code>属性添加事件监听。</li></ol> <p><strong>因此<code>v-model</code>语法糖最终反应的结果，是通过监听表单控件自身的<code>input</code>事件(其他类型有不同的监听事件类型)，去影响自身的<code>value</code>值</strong>。如果没有<code>v-model</code>的语法糖，我们可以这样写：
<code>&lt;input type=&quot;text&quot; :value=&quot;message&quot; @input=&quot;(e) =&gt; { this.message = e.target.value }&quot; &gt;</code></p> <h3 id="_11-1-5-语法糖的背后"><a href="#_11-1-5-语法糖的背后" class="header-anchor">#</a> 11.1.5 语法糖的背后</h3> <p><strong>然而<code>v-model</code>仅仅是起到合并语法，创建一个新的语法糖的意义吗？</strong>
**显然答案是否定的，对于需要使用输入法 (如中文、日文、韩文等) 的语言，你会发现 <code>v-model</code> 不会在输入法组合文字过程中得到更新。**这就是<code>v-model</code>的一个重要的特点。它会在事件处理这一层添加新的事件监听<code>compositionstart,compositionend</code>，他们会分别在语言输入的开始和结束时监听到变化，只要借助<code>$event.target.composing</code>，就可以设计出只会在输入法组合文字的结束阶段才更新数据，这有利于提高用户的使用体验。这一部分我想借助脱离框架的表单来帮助理解。</p> <p>脱离框架的一个视图响应数据的实现（效果类似于v-model）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// html</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;inputValue&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">&quot;showValue&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>

<span class="token comment">// js</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">let</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'inputValue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> show <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'showValue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    input<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
    show<span class="token punctuation">.</span>innerText <span class="token operator">=</span> input<span class="token punctuation">.</span>value

    <span class="token keyword">function</span> <span class="token function">onCompositionStart</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>composing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">onCompositionEnd</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>composing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>composing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      show<span class="token punctuation">.</span>innerText <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">onInputChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// e.target.composing表示是否还在输入中</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>composing<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>
      show<span class="token punctuation">.</span>innerText <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
    input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> onInputChange<span class="token punctuation">)</span>
    input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'compositionstart'</span><span class="token punctuation">,</span> onCompositionStart<span class="token punctuation">)</span><span class="token comment">// 组合输入开始</span>
    input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'compositionend'</span><span class="token punctuation">,</span> onCompositionEnd<span class="token punctuation">)</span> <span class="token comment">// 组合输入结束</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="_11-2-组件使用v-model"><a href="#_11-2-组件使用v-model" class="header-anchor">#</a> 11.2 组件使用v-model</h2> <p>最后我们简单说说在父组件中使用<code>v-model</code>,可以先看结论，<strong>组件上使用<code>v-model</code>本质上是子父组件通信的语法糖</strong>。先看一个简单的使用例子。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token punctuation">{</span>
    template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;&lt;input type=&quot;text&quot; :value=&quot;value&quot; @input=&quot;emitEvent&quot;&gt;{{value}}&lt;/div&gt;'</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">emitEvent</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
 <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token punctuation">{</span>
       message<span class="token operator">:</span> <span class="token string">'test'</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   components<span class="token operator">:</span> <span class="token punctuation">{</span>
     child
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   template<span class="token operator">:</span> <span class="token string">'&lt;div id=&quot;app&quot;&gt;&lt;child v-model=&quot;message&quot;&gt;&lt;/child&gt;&lt;/div&gt;'</span><span class="token punctuation">,</span>
   el<span class="token operator">:</span> <span class="token string">'#app'</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>父组件上使用<code>v-model</code>, 子组件默认会利用名为 <code>value</code> 的 <code>prop</code> 和名为 <code>input</code> 的事件，当然像<code>select</code>表单会以其他默认事件的形式存在。分析源码的过程也大致类似，这里只列举几个特别的地方。</p> <p><code>AST</code>生成阶段和普通表单控件的区别在于，当遇到<code>child</code>时，由于不是普通的<code>html</code>标签，会执行<code>getComponentModel</code>的过程,而<code>getComponentModel</code>的结果是在<code>AST</code>树上添加<code>model</code>的属性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">genComponentModel</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">genComponentModel</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span>value<span class="token punctuation">,</span>modifiers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ref <span class="token operator">=</span> modifiers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> number <span class="token operator">=</span> ref<span class="token punctuation">.</span>number<span class="token punctuation">;</span>
    <span class="token keyword">var</span> trim <span class="token operator">=</span> ref<span class="token punctuation">.</span>trim<span class="token punctuation">;</span>

    <span class="token keyword">var</span> baseValueExpression <span class="token operator">=</span> <span class="token string">'$$v'</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> valueExpression <span class="token operator">=</span> baseValueExpression<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      valueExpression <span class="token operator">=</span>
        <span class="token string">&quot;(typeof &quot;</span> <span class="token operator">+</span> baseValueExpression <span class="token operator">+</span> <span class="token string">&quot; === 'string'&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;? &quot;</span> <span class="token operator">+</span> baseValueExpression <span class="token operator">+</span> <span class="token string">&quot;.trim()&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> baseValueExpression <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      valueExpression <span class="token operator">=</span> <span class="token string">&quot;_n(&quot;</span> <span class="token operator">+</span> valueExpression <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> assignment <span class="token operator">=</span> <span class="token function">genAssignmentCode</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> valueExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在ast树上添加model属性，其中有value，expression，callback属性</span>
    el<span class="token punctuation">.</span>model <span class="token operator">=</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      expression<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
      callback<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">&quot;function (&quot;</span> <span class="token operator">+</span> baseValueExpression <span class="token operator">+</span> <span class="token string">&quot;) {&quot;</span> <span class="token operator">+</span> assignment <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>最终<code>AST</code>树的结果：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  model<span class="token operator">:</span> <span class="token punctuation">{</span>
    callback<span class="token operator">:</span> <span class="token string">&quot;function ($$v) {message=$$v}&quot;</span>
    expression<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>message<span class="token string">&quot;&quot;</span>
    value<span class="token operator">:</span> <span class="token string">&quot;(message)&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>经过对<code>AST</code>树的处理后，回到<code>genData$2</code>的流程，由于有了<code>model</code>属性，父组件拼接的字符串会做进一步处理。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genData$2</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">'{'</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> dirs <span class="token operator">=</span> <span class="token function">genDirectives</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ···
  <span class="token comment">// v-model组件的render函数处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token string">&quot;model:{value:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>model<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,callback:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>model<span class="token punctuation">.</span>callback<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,expression:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>model<span class="token punctuation">.</span>expression<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;},&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ···
  <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>因此，父组件最终的<code>render</code>函数表现为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;_c('child',{model:{value:(message),callback:function ($$v) {message=$$v},expression:&quot;</span>message<span class="token string">&quot;}})&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>子组件的创建阶段照例会执行<code>createComponent</code>，其中针对<code>model</code>的逻辑需要特别说明。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// transform component v-model data into props &amp; events</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理父组件的v-model指令对象</span>
    <span class="token function">transformModel</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">.</span>options<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">transformModel</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// prop默认取的是value，除非配置上有model的选项</span>
  <span class="token keyword">var</span> prop <span class="token operator">=</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>model <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>model<span class="token punctuation">.</span>prop<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'value'</span><span class="token punctuation">;</span>

  <span class="token comment">// event默认取的是input，除非配置上有model的选项</span>
  <span class="token keyword">var</span> event <span class="token operator">=</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>model <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>model<span class="token punctuation">.</span>event<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'input'</span>
  <span class="token comment">// vnode上新增props的属性，值为value</span>
  <span class="token punctuation">;</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>attrs <span class="token operator">||</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>model<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

  <span class="token comment">// vnode上新增on属性，标记事件</span>
  <span class="token keyword">var</span> on <span class="token operator">=</span> data<span class="token punctuation">.</span>on <span class="token operator">||</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>on <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> existing <span class="token operator">=</span> on<span class="token punctuation">[</span>event<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> callback <span class="token operator">=</span> data<span class="token punctuation">.</span>model<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span>
        <span class="token operator">?</span> existing<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token operator">:</span> existing <span class="token operator">!==</span> callback
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      on<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    on<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>从<code>transformModel</code>的逻辑可以看出，子组件<code>vnode</code>会为<code>data.props</code> 添加 <code>data.model.value</code>，并且给<code>data.on</code> 添加<code>data.model.callback</code>。因此父组件<code>v-model</code>语法糖本质上可以修改为
<code>'&lt;child :value=&quot;message&quot; @input=&quot;function(e){message = e}&quot;&gt;&lt;/child&gt;'</code></p> <p><strong>显然，这种写法就是事件通信的写法，这个过程又回到对事件指令的分析过程了。因此我们可以很明显的意识到，组件使用<code>v-model</code>本质上还是一个子父组件通信的语法糖。</strong></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book-docs/vue-depth-analysis/丰富的选项合并策略.html" class="prev">
        丰富的选项合并策略.md
      </a></span> <span class="next"><a href="/book-docs/vue-depth-analysis/动态组件的深入分析.html">
        动态组件的深入分析.md
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/book-docs/vue-depth-analysis/assets/js/app.51ae15a7.js" defer></script><script src="/book-docs/vue-depth-analysis/assets/js/2.d669090a.js" defer></script><script src="/book-docs/vue-depth-analysis/assets/js/9.46e95ee8.js" defer></script>
  </body>
</html>
