(window.webpackJsonp=window.webpackJsonp||[]).push([[218],{420:function(s,t,a){"use strict";a.r(t);var e=a(54),v=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"面试官-说说webpack的热更新是如何做到的-原理是什么"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#面试官-说说webpack的热更新是如何做到的-原理是什么"}},[s._v("#")]),s._v(" 面试官：说说webpack的热更新是如何做到的？原理是什么？")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static.vue-js.com/a076da40-acd4-11eb-85f6-6fac77c0c9b3.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"一、是什么"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、是什么"}},[s._v("#")]),s._v(" 一、是什么")]),s._v(" "),a("p",[a("code",[s._v("HMR")]),s._v("全称 "),a("code",[s._v("Hot Module Replacement")]),s._v("，可以理解为模块热替换，指在应用程序运行过程中，替换、添加、删除模块，而无需重新刷新整个应用")]),s._v(" "),a("p",[s._v("例如，我们在应用运行过程中修改了某个模块，通过自动刷新会导致整个应用的整体刷新，那页面中的状态信息都会丢失")]),s._v(" "),a("p",[s._v("如果使用的是 "),a("code",[s._v("HMR")]),s._v("，就可以实现只将修改的模块实时替换至应用中，不必完全刷新整个应用")]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("webpack")]),s._v("中配置开启热模块也非常的简单，如下代码：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" webpack "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'webpack'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n  devServer"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 开启 HMR 特性")]),s._v("\n    hot"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// hotOnly: true")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("通过上述这种配置，如果我们修改并保存"),a("code",[s._v("css")]),s._v("文件，确实能够以不刷新的形式更新到页面中")]),s._v(" "),a("p",[s._v("但是，当我们修改并保存"),a("code",[s._v("js")]),s._v("文件之后，页面依旧自动刷新了，这里并没有触发热模块")]),s._v(" "),a("p",[s._v("所以，"),a("code",[s._v("HMR")]),s._v("并不像 "),a("code",[s._v("Webpack")]),s._v(" 的其他特性一样可以开箱即用，需要有一些额外的操作")]),s._v(" "),a("p",[s._v("我们需要去指定哪些模块发生更新时进行"),a("code",[s._v("HRM")]),s._v("，如下代码：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("hot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("hot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("accept")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./util.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"util.js更新了"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"二、实现原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、实现原理"}},[s._v("#")]),s._v(" 二、实现原理")]),s._v(" "),a("p",[s._v("首先来看看一张图，如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static.vue-js.com/adc05780-acd4-11eb-ab90-d9ae814b240d.png",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("Webpack Compile：将 JS 源代码编译成 bundle.js")]),s._v(" "),a("li",[s._v("HMR Server：用来将热更新的文件输出给 HMR Runtime")]),s._v(" "),a("li",[s._v("Bundle Server：静态资源文件服务器，提供文件访问路径")]),s._v(" "),a("li",[s._v("HMR Runtime：socket服务器，会被注入到浏览器，更新文件的变化")]),s._v(" "),a("li",[s._v("bundle.js：构建输出的文件")]),s._v(" "),a("li",[s._v("在HMR Runtime 和 HMR Server之间建立 websocket，即图上4号线，用于实时更新文件变化")])]),s._v(" "),a("p",[s._v("上面图中，可以分成两个阶段：")]),s._v(" "),a("ul",[a("li",[s._v("启动阶段为上图 1 - 2 - A - B")])]),s._v(" "),a("p",[s._v("在编写未经过"),a("code",[s._v("webpack")]),s._v("打包的源代码后，"),a("code",[s._v("Webpack Compile")]),s._v(" 将源代码和 "),a("code",[s._v("HMR Runtime")]),s._v(" 一起编译成 "),a("code",[s._v("bundle")]),s._v("文件，传输给"),a("code",[s._v("Bundle Server")]),s._v(" 静态资源服务器")]),s._v(" "),a("ul",[a("li",[s._v("更新阶段为上图 1 - 2 - 3 - 4")])]),s._v(" "),a("p",[s._v("当某一个文件或者模块发生变化时，"),a("code",[s._v("webpack")]),s._v("监听到文件变化对文件重新编译打包，编译生成唯一的"),a("code",[s._v("hash")]),s._v("值，这个"),a("code",[s._v("hash")]),s._v("值用来作为下一次热更新的标识")]),s._v(" "),a("p",[s._v("根据变化的内容生成两个补丁文件："),a("code",[s._v("manifest")]),s._v("（包含了 "),a("code",[s._v("hash")]),s._v(" 和 "),a("code",[s._v("chundId")]),s._v("，用来说明变化的内容）和"),a("code",[s._v("chunk.js")]),s._v(" 模块")]),s._v(" "),a("p",[s._v("由于"),a("code",[s._v("socket")]),s._v("服务器在"),a("code",[s._v("HMR Runtime")]),s._v(" 和 "),a("code",[s._v("HMR Server")]),s._v("之间建立 "),a("code",[s._v("websocket")]),s._v("链接，当文件发生改动的时候，服务端会向浏览器推送一条消息，消息包含文件改动后生成的"),a("code",[s._v("hash")]),s._v("值，如下图的"),a("code",[s._v("h")]),s._v("属性，作为下一次热更细的标识")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static.vue-js.com/05a0edf0-ad4a-11eb-85f6-6fac77c0c9b3.png",alt:""}})]),s._v(" "),a("p",[s._v("在浏览器接受到这条消息之前，浏览器已经在上一次"),a("code",[s._v("socket")]),s._v(" 消息中已经记住了此时的"),a("code",[s._v("hash")]),s._v(" 标识，这时候我们会创建一个 "),a("code",[s._v("ajax")]),s._v(" 去服务端请求获取到变化内容的 "),a("code",[s._v("manifest")]),s._v(" 文件")]),s._v(" "),a("p",[a("code",[s._v("mainfest")]),s._v("文件包含重新"),a("code",[s._v("build")]),s._v("生成的"),a("code",[s._v("hash")]),s._v("值，以及变化的模块，对应上图的"),a("code",[s._v("c")]),s._v("属性")]),s._v(" "),a("p",[s._v("浏览器根据 "),a("code",[s._v("manifest")]),s._v(" 文件获取模块变化的内容，从而触发"),a("code",[s._v("render")]),s._v("流程，实现局部模块更新")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://static.vue-js.com/0e7b7850-ad4a-11eb-ab90-d9ae814b240d.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"三、总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、总结"}},[s._v("#")]),s._v(" 三、总结")]),s._v(" "),a("p",[s._v("关于"),a("code",[s._v("webpack")]),s._v("热模块更新的总结如下：")]),s._v(" "),a("ul",[a("li",[s._v("通过"),a("code",[s._v("webpack-dev-server")]),s._v("创建两个服务器：提供静态资源的服务（express）和Socket服务")]),s._v(" "),a("li",[s._v("express server 负责直接提供静态资源的服务（打包后的资源直接被浏览器请求和解析）")]),s._v(" "),a("li",[s._v("socket server 是一个 websocket 的长连接，双方可以通信")]),s._v(" "),a("li",[s._v("当 socket server 监听到对应的模块发生变化时，会生成两个文件.json（manifest文件）和.js文件（update chunk）")]),s._v(" "),a("li",[s._v("通过长连接，socket server 可以直接将这两个文件主动发送给客户端（浏览器）")]),s._v(" "),a("li",[s._v("浏览器拿到两个新的文件后，通过HMR runtime机制，加载这两个文件，并且针对修改的模块进行更新")])]),s._v(" "),a("h2",{attrs:{id:"参考文献"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[s._v("#")]),s._v(" 参考文献")]),s._v(" "),a("ul",[a("li",[s._v("https://zhuanlan.zhihu.com/p/138446061")]),s._v(" "),a("li",[s._v("https://github.com/Jocs/jocs.github.io/issues/15")]),s._v(" "),a("li",[s._v("https://juejin.cn/post/6844904134697549832")]),s._v(" "),a("li",[s._v("https://vue3js.cn/interview/")])])])}),[],!1,null,null,null);t.default=v.exports}}]);