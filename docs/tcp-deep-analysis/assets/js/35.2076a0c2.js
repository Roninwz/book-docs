(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{420:function(t,e,n){"use strict";n.r(e);var a=n(54),s=Object(a.a)({},(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("p",[t._v("这篇文章我们以 JDBC 批量插入的问题来看看网络分析在实际工作用的最简单的应用。")]),t._v(" "),n("p",[t._v("几年前遇到过一个问题，使用 jdbc 批量插入，插入的性能总是上不去，看代码又查不出什么结果。代码简化以后如下：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v('public static void main(String[] args) throws ClassNotFoundException, SQLException {\n    Class.forName("com.mysql.jdbc.Driver");\n\n    String url = "jdbc:mysql://localhost:3306/test?useSSL=false";\n    Connection connection = DriverManager.getConnection(url, "root", "");\n    PreparedStatement statement = connection.prepareStatement("insert into batch_insert_test(name)values(?)");\n\n    for (int i = 0; i < 10; i++) {\n        statement.setString(1, "name#" + System.currentTimeMillis() + "#" + i);\n        statement.addBatch();\n    }\n    statement.executeBatch();\n}\n')])])]),n("p",[t._v("通过 wireshark 抓包，结果如下")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/4/2/169dc5d37554c47f",alt:""}})]),t._v(" "),n("p",[t._v("可以看到 jdbc 实际上是发送了 10 次 insert 请求，既不能降低网络通信的成本，也不能在服务器上批量执行。")]),t._v(" "),n("p",[t._v("单步调试，发现调用到了"),n("code",[t._v("executeBatchSerially")])]),t._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/4/2/169dc5d3748f9d16",alt:""}})]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v("protected long[] executeBatchSerially(int batchTimeout) throws SQLException\n")])])]),n("p",[t._v("看源码发现跟"),n("code",[t._v("connection.getRewriteBatchedStatements()")]),t._v("有关，当等于 true 时，会进入批量插入的流程，等于 false 时，进入逐条插入的流程。")]),t._v(" "),n("p",[t._v("修改 sql 连接的参数，增加"),n("code",[t._v("rewriteBatchedStatements=true")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v('// String url = "jdbc:mysql://localhost:3306/test?useSSL=false";\nString url = "jdbc:mysql://localhost:3306/test?useSSL=false&rewriteBatchedStatements=true";\n')])])]),n("p",[t._v("单步调试，可以看到这下进入到批量插入的逻辑了。")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/4/2/169dc5d36f57e24d",alt:""}})]),t._v(" "),n("p",[t._v("wireshark 抓包情况如下，可以确认批量插入生效了")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/4/2/169dc5d37d90af87",alt:""}})]),t._v(" "),n("p",[t._v("rewriteBatchedStatements 参数将")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v("insert into batch_insert_test(name)values('name#1554175696958#0')\ninsert into batch_insert_test(name)values('name#1554175696958#1')\ninsert into batch_insert_test(name)values('name#1554175696958#2')\ninsert into batch_insert_test(name)values('name#1554175696958#3')\ninsert into batch_insert_test(name)values('name#1554175696958#4')\ninsert into batch_insert_test(name)values('name#1554175696958#5')\ninsert into batch_insert_test(name)values('name#1554175696958#6')\ninsert into batch_insert_test(name)values('name#1554175696958#7')\ninsert into batch_insert_test(name)values('name#1554175696958#8')\ninsert into batch_insert_test(name)values('name#1554175696958#9')\n")])])]),n("p",[t._v("改写为真正的批量插入")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",[n("code",[t._v("insert into batch_insert_test(name)values\n('name#1554175696958#0'),('name#1554175696958#1'),\n('name#1554175696958#2'),('name#1554175696958#3'),\n('name#1554175696958#4'),('name#1554175696958#5'),\n('name#1554175696958#6'),('name#1554175696958#7'),\n('name#1554175696958#8'),('name#1554175696958#9')\n")])])]),n("h2",{attrs:{id:"小结与思考"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#小结与思考"}},[t._v("#")]),t._v(" 小结与思考")]),t._v(" "),n("p",[t._v("这篇文章以一个非常简单的例子讲述了在用抓包工具来解决在 JDBC 上批量插入效率低下的问题。我们经常会用很多第三方的库，这些库我们一般没有精力把每行代码都读通读透，遇到问题时，抓一些包就可以很快确定问题的所在，这就是抓包网络分析的魅力所在。")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://juejin.im/book/6844733788681928712/section/6844733788853911560",target:"_blank",rel:"noopener noreferrer"}},[t._v("Source"),n("OutboundLink")],1)])])}),[],!1,null,null,null);e.default=s.exports}}]);